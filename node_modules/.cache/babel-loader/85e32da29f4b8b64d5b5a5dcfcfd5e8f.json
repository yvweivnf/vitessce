{"ast":null,"code":"import _createForOfIteratorHelper from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createForOfIteratorHelper\";\nimport _toConsumableArray from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";\nimport _objectSpread from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";\nimport _regeneratorRuntime from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";\nimport _asyncToGenerator from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";\nimport _getPrototypeOf from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/getPrototypeOf\";\nimport _get from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/get\";\nimport _inherits from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";\nimport _createSuper from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";\nimport { log } from '@deck.gl/core';\nimport { Matrix4 } from 'math.gl';\nimport { MVTWorkerLoader } from '@loaders.gl/mvt';\nimport { binaryToGeojson } from '@loaders.gl/gis';\nimport { COORDINATE_SYSTEM } from '@deck.gl/core';\nimport { ClipExtension } from '@deck.gl/extensions';\nimport TileLayer from '../tile-layer/tile-layer';\nimport { getURLFromTemplate, isURLTemplate } from '../tile-layer/utils';\nimport { transform } from './coordinate-transform';\nimport findIndexBinary from './find-index-binary';\nimport { GeoJsonLayer } from '@deck.gl/layers';\nvar WORLD_SIZE = 512;\nvar defaultProps = {\n  uniqueIdProperty: {\n    type: 'string',\n    value: ''\n  },\n  highlightedFeatureId: null,\n  loaders: [MVTWorkerLoader],\n  binary: true\n};\n\nvar MVTLayer = /*#__PURE__*/function (_TileLayer) {\n  _inherits(MVTLayer, _TileLayer);\n\n  var _super = _createSuper(MVTLayer);\n\n  function MVTLayer() {\n    _classCallCheck(this, MVTLayer);\n\n    return _super.apply(this, arguments);\n  }\n\n  _createClass(MVTLayer, [{\n    key: \"initializeState\",\n    value: function initializeState() {\n      _get(_getPrototypeOf(MVTLayer.prototype), \"initializeState\", this).call(this);\n\n      this.setState({\n        data: null,\n        tileJSON: null\n      });\n    }\n  }, {\n    key: \"updateState\",\n    value: function updateState(_ref) {\n      var props = _ref.props,\n          oldProps = _ref.oldProps,\n          context = _ref.context,\n          changeFlags = _ref.changeFlags;\n\n      if (changeFlags.dataChanged) {\n        this._updateTileData();\n      }\n\n      if (this.state.data) {\n        _get(_getPrototypeOf(MVTLayer.prototype), \"updateState\", this).call(this, {\n          props: props,\n          oldProps: oldProps,\n          context: context,\n          changeFlags: changeFlags\n        });\n\n        this._setWGS84PropertyForTiles();\n      }\n\n      var highlightColor = props.highlightColor;\n\n      if (highlightColor !== oldProps.highlightColor && Array.isArray(highlightColor)) {\n        this.setState({\n          highlightColor: highlightColor\n        });\n      }\n    }\n  }, {\n    key: \"_updateTileData\",\n    value: function () {\n      var _updateTileData2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var data, tileJSON, _this$props, onDataLoad, fetch;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                data = this.props.data;\n                tileJSON = null;\n\n                if (!(typeof data === 'string' && !isURLTemplate(data))) {\n                  _context.next = 18;\n                  break;\n                }\n\n                _this$props = this.props, onDataLoad = _this$props.onDataLoad, fetch = _this$props.fetch;\n                this.setState({\n                  data: null,\n                  tileJSON: null\n                });\n                _context.prev = 5;\n                _context.next = 8;\n                return fetch(data, {\n                  propName: 'data',\n                  layer: this,\n                  loaders: []\n                });\n\n              case 8:\n                tileJSON = _context.sent;\n                _context.next = 15;\n                break;\n\n              case 11:\n                _context.prev = 11;\n                _context.t0 = _context[\"catch\"](5);\n                this.raiseError(_context.t0, 'loading TileJSON');\n                data = null;\n\n              case 15:\n                if (onDataLoad) {\n                  onDataLoad(tileJSON);\n                }\n\n                _context.next = 19;\n                break;\n\n              case 18:\n                if (data.tilejson) {\n                  tileJSON = data;\n                }\n\n              case 19:\n                if (tileJSON) {\n                  data = tileJSON.tiles;\n                }\n\n                this.setState({\n                  data: data,\n                  tileJSON: tileJSON\n                });\n\n              case 21:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[5, 11]]);\n      }));\n\n      function _updateTileData() {\n        return _updateTileData2.apply(this, arguments);\n      }\n\n      return _updateTileData;\n    }()\n  }, {\n    key: \"_getTilesetOptions\",\n    value: function _getTilesetOptions(props) {\n      var opts = _get(_getPrototypeOf(MVTLayer.prototype), \"_getTilesetOptions\", this).call(this, props);\n\n      var tileJSON = this.state.tileJSON;\n\n      if (tileJSON) {\n        if (Number.isFinite(tileJSON.minzoom) && tileJSON.minzoom > props.minZoom) {\n          opts.minZoom = tileJSON.minzoom;\n        }\n\n        if (Number.isFinite(tileJSON.maxzoom) && (!Number.isFinite(props.maxZoom) || tileJSON.maxzoom < props.maxZoom)) {\n          opts.maxZoom = tileJSON.maxzoom;\n        }\n      }\n\n      return opts;\n    }\n  }, {\n    key: \"renderLayers\",\n    value: function renderLayers() {\n      if (!this.state.data) return null;\n      return _get(_getPrototypeOf(MVTLayer.prototype), \"renderLayers\", this).call(this);\n    }\n  }, {\n    key: \"getTileData\",\n    value: function getTileData(tile) {\n      var _loadOptions;\n\n      var url = getURLFromTemplate(this.state.data, tile);\n\n      if (!url) {\n        return Promise.reject('Invalid URL');\n      }\n\n      var loadOptions = this.getLoadOptions();\n      var _this$props2 = this.props,\n          binary = _this$props2.binary,\n          fetch = _this$props2.fetch;\n      var signal = tile.signal,\n          x = tile.x,\n          y = tile.y,\n          z = tile.z;\n      loadOptions = _objectSpread({}, loadOptions, {\n        mimeType: 'application/x-protobuf',\n        mvt: _objectSpread({}, (_loadOptions = loadOptions) === null || _loadOptions === void 0 ? void 0 : _loadOptions.mvt, {\n          coordinates: this.context.viewport.resolution ? 'wgs84' : 'local',\n          tileIndex: {\n            x: x,\n            y: y,\n            z: z\n          }\n        }),\n        gis: binary ? {\n          format: 'binary'\n        } : {}\n      });\n      return fetch(url, {\n        propName: 'data',\n        layer: this,\n        loadOptions: loadOptions,\n        signal: signal\n      });\n    }\n  }, {\n    key: \"renderSubLayers\",\n    value: function renderSubLayers(props) {\n      var tile = props.tile;\n      var worldScale = Math.pow(2, tile.z);\n      var xScale = WORLD_SIZE / worldScale;\n      var yScale = -xScale;\n      var xOffset = WORLD_SIZE * tile.x / worldScale;\n      var yOffset = WORLD_SIZE * (1 - tile.y / worldScale);\n      var modelMatrix = new Matrix4().scale([xScale, yScale, 1]);\n      props.autoHighlight = false;\n\n      if (!this.context.viewport.resolution) {\n        props.modelMatrix = modelMatrix;\n        props.coordinateOrigin = [xOffset, yOffset, 0];\n        props.coordinateSystem = COORDINATE_SYSTEM.CARTESIAN;\n        props.extensions = [].concat(_toConsumableArray(props.extensions || []), [new ClipExtension()]);\n      }\n\n      var subLayers = _get(_getPrototypeOf(MVTLayer.prototype), \"renderSubLayers\", this).call(this, props);\n\n      if (this.props.binary && !(subLayers instanceof GeoJsonLayer)) {\n        log.warn('renderSubLayers() must return GeoJsonLayer when using binary:true')();\n      }\n\n      return subLayers;\n    }\n  }, {\n    key: \"_updateAutoHighlight\",\n    value: function _updateAutoHighlight(info) {\n      var uniqueIdProperty = this.props.uniqueIdProperty;\n      var _this$state = this.state,\n          hoveredFeatureId = _this$state.hoveredFeatureId,\n          hoveredFeatureLayerName = _this$state.hoveredFeatureLayerName;\n      var hoveredFeature = info.object;\n      var newHoveredFeatureId;\n      var newHoveredFeatureLayerName;\n\n      if (hoveredFeature) {\n        newHoveredFeatureId = getFeatureUniqueId(hoveredFeature, uniqueIdProperty);\n        newHoveredFeatureLayerName = getFeatureLayerName(hoveredFeature);\n      }\n\n      var highlightColor = this.props.highlightColor;\n\n      if (typeof highlightColor === 'function') {\n        highlightColor = highlightColor(info);\n      }\n\n      if (hoveredFeatureId !== newHoveredFeatureId || hoveredFeatureLayerName !== newHoveredFeatureLayerName) {\n        this.setState({\n          highlightColor: highlightColor,\n          hoveredFeatureId: newHoveredFeatureId,\n          hoveredFeatureLayerName: newHoveredFeatureLayerName\n        });\n      }\n    }\n  }, {\n    key: \"getPickingInfo\",\n    value: function getPickingInfo(params) {\n      var info = _get(_getPrototypeOf(MVTLayer.prototype), \"getPickingInfo\", this).call(this, params);\n\n      var isWGS84 = this.context.viewport.resolution;\n\n      if (this.props.binary && info.index !== -1) {\n        var data = params.sourceLayer.props.data;\n        info.object = binaryToGeojson(data, {\n          globalFeatureId: info.index\n        });\n      }\n\n      if (info.object && !isWGS84) {\n        info.object = transformTileCoordsToWGS84(info.object, info.tile.bbox, this.context.viewport);\n      }\n\n      return info;\n    }\n  }, {\n    key: \"getSubLayerPropsByTile\",\n    value: function getSubLayerPropsByTile(tile) {\n      return {\n        highlightedObjectIndex: this.getHighlightedObjectIndex(tile),\n        highlightColor: this.state.highlightColor\n      };\n    }\n  }, {\n    key: \"getHighlightedObjectIndex\",\n    value: function getHighlightedObjectIndex(tile) {\n      var _this$state2 = this.state,\n          hoveredFeatureId = _this$state2.hoveredFeatureId,\n          hoveredFeatureLayerName = _this$state2.hoveredFeatureLayerName;\n      var _this$props3 = this.props,\n          uniqueIdProperty = _this$props3.uniqueIdProperty,\n          highlightedFeatureId = _this$props3.highlightedFeatureId,\n          binary = _this$props3.binary;\n      var data = tile.content;\n      var isHighlighted = isFeatureIdDefined(highlightedFeatureId);\n      var isFeatureIdPresent = isFeatureIdDefined(hoveredFeatureId) || isHighlighted;\n\n      if (!isFeatureIdPresent) {\n        return -1;\n      }\n\n      var featureIdToHighlight = isHighlighted ? highlightedFeatureId : hoveredFeatureId;\n\n      if (Array.isArray(data)) {\n        return data.findIndex(function (feature) {\n          var isMatchingId = getFeatureUniqueId(feature, uniqueIdProperty) === featureIdToHighlight;\n          var isMatchingLayer = isHighlighted || getFeatureLayerName(feature) === hoveredFeatureLayerName;\n          return isMatchingId && isMatchingLayer;\n        });\n      } else if (data && binary) {\n        return findIndexBinary(data, uniqueIdProperty, featureIdToHighlight, isHighlighted ? '' : hoveredFeatureLayerName);\n      }\n\n      return -1;\n    }\n  }, {\n    key: \"_pickObjects\",\n    value: function _pickObjects(maxObjects) {\n      var _this$context = this.context,\n          deck = _this$context.deck,\n          viewport = _this$context.viewport;\n      var width = viewport.width;\n      var height = viewport.height;\n      var x = viewport.x;\n      var y = viewport.y;\n      var layerIds = [this.id];\n      return deck.pickObjects({\n        x: x,\n        y: y,\n        width: width,\n        height: height,\n        layerIds: layerIds,\n        maxObjects: maxObjects\n      });\n    }\n  }, {\n    key: \"getRenderedFeatures\",\n    value: function getRenderedFeatures() {\n      var maxFeatures = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n\n      var features = this._pickObjects(maxFeatures);\n\n      var featureCache = new Set();\n      var renderedFeatures = [];\n\n      var _iterator = _createForOfIteratorHelper(features),\n          _step;\n\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var f = _step.value;\n          var featureId = getFeatureUniqueId(f.object, this.props.uniqueIdProperty);\n\n          if (featureId === undefined) {\n            renderedFeatures.push(f.object);\n          } else if (!featureCache.has(featureId)) {\n            featureCache.add(featureId);\n            renderedFeatures.push(f.object);\n          }\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n\n      return renderedFeatures;\n    }\n  }, {\n    key: \"_setWGS84PropertyForTiles\",\n    value: function _setWGS84PropertyForTiles() {\n      var _this = this;\n\n      var propName = 'dataInWGS84';\n      var tileset = this.state.tileset;\n      tileset.selectedTiles.forEach(function (tile) {\n        if (!tile.hasOwnProperty(propName)) {\n          Object.defineProperty(tile, propName, {\n            get: function get() {\n              if (!tile.content) {\n                return null;\n              }\n\n              if (_this.props.binary && Array.isArray(tile.content) && !tile.content.length) {\n                return [];\n              }\n\n              if (tile._contentWGS84 === undefined) {\n                var content = _this.props.binary ? binaryToGeojson(tile.content) : tile.content;\n                tile._contentWGS84 = content.map(function (feature) {\n                  return transformTileCoordsToWGS84(feature, tile.bbox, _this.context.viewport);\n                });\n              }\n\n              return tile._contentWGS84;\n            }\n          });\n        }\n      });\n    }\n  }, {\n    key: \"isLoaded\",\n    get: function get() {\n      return this.state.data && this.state.tileset && _get(_getPrototypeOf(MVTLayer.prototype), \"isLoaded\", this);\n    }\n  }]);\n\n  return MVTLayer;\n}(TileLayer);\n\nexport { MVTLayer as default };\n\nfunction getFeatureUniqueId(feature, uniqueIdProperty) {\n  if (uniqueIdProperty) {\n    return feature.properties[uniqueIdProperty];\n  }\n\n  if ('id' in feature) {\n    return feature.id;\n  }\n\n  return undefined;\n}\n\nfunction getFeatureLayerName(feature) {\n  var _feature$properties;\n\n  return ((_feature$properties = feature.properties) === null || _feature$properties === void 0 ? void 0 : _feature$properties.layerName) || null;\n}\n\nfunction isFeatureIdDefined(value) {\n  return value !== undefined && value !== null && value !== '';\n}\n\nfunction transformTileCoordsToWGS84(object, bbox, viewport) {\n  var feature = _objectSpread({}, object, {\n    geometry: {\n      type: object.geometry.type\n    }\n  });\n\n  Object.defineProperty(feature.geometry, 'coordinates', {\n    get: function get() {\n      var wgs84Geom = transform(object.geometry, bbox, viewport);\n      return wgs84Geom.coordinates;\n    }\n  });\n  return feature;\n}\n\nMVTLayer.layerName = 'MVTLayer';\nMVTLayer.defaultProps = defaultProps;","map":{"version":3,"sources":["../../../src/mvt-layer/mvt-layer.js"],"names":["WORLD_SIZE","defaultProps","uniqueIdProperty","type","value","highlightedFeatureId","loaders","binary","data","tileJSON","changeFlags","props","oldProps","context","highlightColor","Array","isURLTemplate","fetch","propName","layer","onDataLoad","opts","Number","url","getURLFromTemplate","Promise","loadOptions","z","mimeType","mvt","coordinates","tileIndex","x","y","gis","format","signal","tile","worldScale","Math","xScale","yScale","xOffset","yOffset","modelMatrix","COORDINATE_SYSTEM","subLayers","log","hoveredFeatureLayerName","hoveredFeature","info","newHoveredFeatureId","getFeatureUniqueId","newHoveredFeatureLayerName","getFeatureLayerName","hoveredFeatureId","isWGS84","params","binaryToGeojson","globalFeatureId","index","transformTileCoordsToWGS84","highlightedObjectIndex","isHighlighted","isFeatureIdDefined","isFeatureIdPresent","featureIdToHighlight","feature","isMatchingId","isMatchingLayer","findIndexBinary","viewport","width","height","layerIds","maxObjects","maxFeatures","features","featureCache","renderedFeatures","featureId","f","tileset","Object","get","content","geometry","object","wgs84Geom","transform","MVTLayer"],"mappings":"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","sourcesContent":["import {log} from '@deck.gl/core';\nimport {Matrix4} from 'math.gl';\nimport {MVTWorkerLoader} from '@loaders.gl/mvt';\nimport {binaryToGeojson} from '@loaders.gl/gis';\nimport {COORDINATE_SYSTEM} from '@deck.gl/core';\nimport {ClipExtension} from '@deck.gl/extensions';\n\nimport TileLayer from '../tile-layer/tile-layer';\nimport {getURLFromTemplate, isURLTemplate} from '../tile-layer/utils';\nimport {transform} from './coordinate-transform';\nimport findIndexBinary from './find-index-binary';\n\nimport {GeoJsonLayer} from '@deck.gl/layers';\n\nconst WORLD_SIZE = 512;\n\nconst defaultProps = {\n  uniqueIdProperty: {type: 'string', value: ''},\n  highlightedFeatureId: null,\n  loaders: [MVTWorkerLoader],\n  binary: true\n};\n\nexport default class MVTLayer extends TileLayer {\n  initializeState() {\n    super.initializeState();\n    this.setState({\n      data: null,\n      tileJSON: null\n    });\n  }\n\n  get isLoaded() {\n    return this.state.data && this.state.tileset && super.isLoaded;\n  }\n\n  updateState({props, oldProps, context, changeFlags}) {\n    if (changeFlags.dataChanged) {\n      this._updateTileData();\n    }\n\n    if (this.state.data) {\n      super.updateState({props, oldProps, context, changeFlags});\n      this._setWGS84PropertyForTiles();\n    }\n    const {highlightColor} = props;\n    if (highlightColor !== oldProps.highlightColor && Array.isArray(highlightColor)) {\n      this.setState({highlightColor});\n    }\n  }\n\n  /* eslint-disable complexity */\n  async _updateTileData() {\n    let {data} = this.props;\n    let tileJSON = null;\n\n    if (typeof data === 'string' && !isURLTemplate(data)) {\n      const {onDataLoad, fetch} = this.props;\n      this.setState({data: null, tileJSON: null});\n      try {\n        tileJSON = await fetch(data, {propName: 'data', layer: this, loaders: []});\n      } catch (error) {\n        this.raiseError(error, 'loading TileJSON');\n        data = null;\n      }\n\n      if (onDataLoad) {\n        onDataLoad(tileJSON);\n      }\n    } else if (data.tilejson) {\n      tileJSON = data;\n    }\n\n    if (tileJSON) {\n      data = tileJSON.tiles;\n    }\n\n    this.setState({data, tileJSON});\n  }\n\n  _getTilesetOptions(props) {\n    const opts = super._getTilesetOptions(props);\n    const {tileJSON} = this.state;\n\n    if (tileJSON) {\n      if (Number.isFinite(tileJSON.minzoom) && tileJSON.minzoom > props.minZoom) {\n        opts.minZoom = tileJSON.minzoom;\n      }\n\n      if (\n        Number.isFinite(tileJSON.maxzoom) &&\n        (!Number.isFinite(props.maxZoom) || tileJSON.maxzoom < props.maxZoom)\n      ) {\n        opts.maxZoom = tileJSON.maxzoom;\n      }\n    }\n    return opts;\n  }\n\n  /* eslint-disable complexity */\n\n  renderLayers() {\n    if (!this.state.data) return null;\n    return super.renderLayers();\n  }\n\n  getTileData(tile) {\n    const url = getURLFromTemplate(this.state.data, tile);\n    if (!url) {\n      return Promise.reject('Invalid URL');\n    }\n    let loadOptions = this.getLoadOptions();\n    const {binary, fetch} = this.props;\n    const {signal, x, y, z} = tile;\n    loadOptions = {\n      ...loadOptions,\n      mimeType: 'application/x-protobuf',\n      mvt: {\n        ...loadOptions?.mvt,\n        coordinates: this.context.viewport.resolution ? 'wgs84' : 'local',\n        tileIndex: {x, y, z}\n        // Local worker debug\n        // workerUrl: `modules/mvt/dist/mvt-loader.worker.js`\n        // Set worker to null to skip web workers\n        // workerUrl: null\n      },\n      gis: binary ? {format: 'binary'} : {}\n    };\n    return fetch(url, {propName: 'data', layer: this, loadOptions, signal});\n  }\n\n  renderSubLayers(props) {\n    const {tile} = props;\n    const worldScale = Math.pow(2, tile.z);\n\n    const xScale = WORLD_SIZE / worldScale;\n    const yScale = -xScale;\n\n    const xOffset = (WORLD_SIZE * tile.x) / worldScale;\n    const yOffset = WORLD_SIZE * (1 - tile.y / worldScale);\n\n    const modelMatrix = new Matrix4().scale([xScale, yScale, 1]);\n\n    props.autoHighlight = false;\n\n    if (!this.context.viewport.resolution) {\n      props.modelMatrix = modelMatrix;\n      props.coordinateOrigin = [xOffset, yOffset, 0];\n      props.coordinateSystem = COORDINATE_SYSTEM.CARTESIAN;\n      props.extensions = [...(props.extensions || []), new ClipExtension()];\n    }\n\n    const subLayers = super.renderSubLayers(props);\n\n    if (this.props.binary && !(subLayers instanceof GeoJsonLayer)) {\n      log.warn('renderSubLayers() must return GeoJsonLayer when using binary:true')();\n    }\n\n    return subLayers;\n  }\n\n  _updateAutoHighlight(info) {\n    const {uniqueIdProperty} = this.props;\n\n    const {hoveredFeatureId, hoveredFeatureLayerName} = this.state;\n    const hoveredFeature = info.object;\n    let newHoveredFeatureId;\n    let newHoveredFeatureLayerName;\n\n    if (hoveredFeature) {\n      newHoveredFeatureId = getFeatureUniqueId(hoveredFeature, uniqueIdProperty);\n      newHoveredFeatureLayerName = getFeatureLayerName(hoveredFeature);\n    }\n    let {highlightColor} = this.props;\n    if (typeof highlightColor === 'function') {\n      highlightColor = highlightColor(info);\n    }\n\n    if (\n      hoveredFeatureId !== newHoveredFeatureId ||\n      hoveredFeatureLayerName !== newHoveredFeatureLayerName\n    ) {\n      this.setState({\n        highlightColor,\n        hoveredFeatureId: newHoveredFeatureId,\n        hoveredFeatureLayerName: newHoveredFeatureLayerName\n      });\n    }\n  }\n\n  getPickingInfo(params) {\n    const info = super.getPickingInfo(params);\n\n    const isWGS84 = this.context.viewport.resolution;\n\n    if (this.props.binary && info.index !== -1) {\n      const {data} = params.sourceLayer.props;\n      info.object = binaryToGeojson(data, {globalFeatureId: info.index});\n    }\n    if (info.object && !isWGS84) {\n      info.object = transformTileCoordsToWGS84(info.object, info.tile.bbox, this.context.viewport);\n    }\n\n    return info;\n  }\n\n  getSubLayerPropsByTile(tile) {\n    return {\n      highlightedObjectIndex: this.getHighlightedObjectIndex(tile),\n      highlightColor: this.state.highlightColor\n    };\n  }\n\n  getHighlightedObjectIndex(tile) {\n    const {hoveredFeatureId, hoveredFeatureLayerName} = this.state;\n    const {uniqueIdProperty, highlightedFeatureId, binary} = this.props;\n    const data = tile.content;\n\n    const isHighlighted = isFeatureIdDefined(highlightedFeatureId);\n    const isFeatureIdPresent = isFeatureIdDefined(hoveredFeatureId) || isHighlighted;\n\n    if (!isFeatureIdPresent) {\n      return -1;\n    }\n\n    const featureIdToHighlight = isHighlighted ? highlightedFeatureId : hoveredFeatureId;\n\n    // Iterable data\n    if (Array.isArray(data)) {\n      return data.findIndex(feature => {\n        const isMatchingId = getFeatureUniqueId(feature, uniqueIdProperty) === featureIdToHighlight;\n        const isMatchingLayer =\n          isHighlighted || getFeatureLayerName(feature) === hoveredFeatureLayerName;\n        return isMatchingId && isMatchingLayer;\n      });\n\n      // Non-iterable data\n    } else if (data && binary) {\n      // Get the feature index of the selected item to highlight\n      return findIndexBinary(\n        data,\n        uniqueIdProperty,\n        featureIdToHighlight,\n        isHighlighted ? '' : hoveredFeatureLayerName\n      );\n    }\n\n    return -1;\n  }\n\n  _pickObjects(maxObjects) {\n    const {deck, viewport} = this.context;\n    const width = viewport.width;\n    const height = viewport.height;\n    const x = viewport.x;\n    const y = viewport.y;\n    const layerIds = [this.id];\n    return deck.pickObjects({x, y, width, height, layerIds, maxObjects});\n  }\n\n  getRenderedFeatures(maxFeatures = null) {\n    const features = this._pickObjects(maxFeatures);\n    const featureCache = new Set();\n    const renderedFeatures = [];\n\n    for (const f of features) {\n      const featureId = getFeatureUniqueId(f.object, this.props.uniqueIdProperty);\n\n      if (featureId === undefined) {\n        // we have no id for the feature, we just add to the list\n        renderedFeatures.push(f.object);\n      } else if (!featureCache.has(featureId)) {\n        // Add removing duplicates\n        featureCache.add(featureId);\n        renderedFeatures.push(f.object);\n      }\n    }\n\n    return renderedFeatures;\n  }\n\n  _setWGS84PropertyForTiles() {\n    const propName = 'dataInWGS84';\n    const {tileset} = this.state;\n\n    tileset.selectedTiles.forEach(tile => {\n      if (!tile.hasOwnProperty(propName)) {\n        // eslint-disable-next-line accessor-pairs\n        Object.defineProperty(tile, propName, {\n          get: () => {\n            // Still loading or encountered an error\n            if (!tile.content) {\n              return null;\n            }\n\n            if (this.props.binary && Array.isArray(tile.content) && !tile.content.length) {\n              // TODO: @loaders.gl/mvt returns [] when no content. It should return a valid empty binary.\n              // https://github.com/visgl/loaders.gl/pull/1137\n              return [];\n            }\n\n            if (tile._contentWGS84 === undefined) {\n              // Create a cache to transform only once\n              const content = this.props.binary ? binaryToGeojson(tile.content) : tile.content;\n              tile._contentWGS84 = content.map(feature =>\n                transformTileCoordsToWGS84(feature, tile.bbox, this.context.viewport)\n              );\n            }\n            return tile._contentWGS84;\n          }\n        });\n      }\n    });\n  }\n}\n\nfunction getFeatureUniqueId(feature, uniqueIdProperty) {\n  if (uniqueIdProperty) {\n    return feature.properties[uniqueIdProperty];\n  }\n\n  if ('id' in feature) {\n    return feature.id;\n  }\n\n  return undefined;\n}\n\nfunction getFeatureLayerName(feature) {\n  return feature.properties?.layerName || null;\n}\n\nfunction isFeatureIdDefined(value) {\n  return value !== undefined && value !== null && value !== '';\n}\n\nfunction transformTileCoordsToWGS84(object, bbox, viewport) {\n  const feature = {\n    ...object,\n    geometry: {\n      type: object.geometry.type\n    }\n  };\n\n  // eslint-disable-next-line accessor-pairs\n  Object.defineProperty(feature.geometry, 'coordinates', {\n    get: () => {\n      const wgs84Geom = transform(object.geometry, bbox, viewport);\n      return wgs84Geom.coordinates;\n    }\n  });\n\n  return feature;\n}\n\nMVTLayer.layerName = 'MVTLayer';\nMVTLayer.defaultProps = defaultProps;\n"]},"metadata":{},"sourceType":"module"}