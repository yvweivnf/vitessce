{"ast":null,"code":"import _classCallCheck from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";\nimport { getTransferList } from '../worker-utils/get-transfer-list';\nvar onMessageWrapperMap = new Map();\n\nvar WorkerBody = /*#__PURE__*/function () {\n  function WorkerBody() {\n    _classCallCheck(this, WorkerBody);\n  }\n\n  _createClass(WorkerBody, null, [{\n    key: \"addEventListener\",\n    value: function addEventListener(onMessage) {\n      var onMessageWrapper = onMessageWrapperMap.get(onMessage);\n\n      if (!onMessageWrapper) {\n        onMessageWrapper = function onMessageWrapper(message) {\n          if (!isKnownMessage(message)) {\n            return;\n          }\n\n          var _message$data = message.data,\n              type = _message$data.type,\n              payload = _message$data.payload;\n          onMessage(type, payload);\n        };\n      }\n\n      self.addEventListener('message', onMessageWrapper);\n    }\n  }, {\n    key: \"removeEventListener\",\n    value: function removeEventListener(onMessage) {\n      var onMessageWrapper = onMessageWrapperMap.get(onMessage);\n      onMessageWrapperMap.delete(onMessage);\n      self.removeEventListener('message', onMessageWrapper);\n    }\n  }, {\n    key: \"postMessage\",\n    value: function postMessage(type, payload) {\n      if (self) {\n        var data = {\n          source: 'loaders.gl',\n          type: type,\n          payload: payload\n        };\n        var transferList = getTransferList(payload);\n        self.postMessage(data, transferList);\n      }\n    }\n  }, {\n    key: \"onmessage\",\n    set: function set(onMessage) {\n      self.onmessage = function (message) {\n        if (!isKnownMessage(message)) {\n          return;\n        }\n\n        var _message$data2 = message.data,\n            type = _message$data2.type,\n            payload = _message$data2.payload;\n        onMessage(type, payload);\n      };\n    }\n  }]);\n\n  return WorkerBody;\n}();\n\nexport { WorkerBody as default };\n\nfunction isKnownMessage(message) {\n  var type = message.type,\n      data = message.data;\n  return type === 'message' && data && typeof data.source === 'string' && data.source.startsWith('loaders.gl');\n}","map":{"version":3,"sources":["../../../../src/lib/worker-farm/worker-body.ts"],"names":["onMessageWrapperMap","self","message","isKnownMessage","payload","onMessage","onMessageWrapper","data","source","type","transferList","getTransferList"],"mappings":";;AACA,SAAA,eAAA,QAAA,mCAAA;AAEA,IAAMA,mBAAmB,GAAG,IAA5B,GAA4B,EAA5B;;IAKe,U;;;;;;;qCAiBU,S,EAErB;AACA,UAAIM,gBAAgB,GAAGN,mBAAmB,CAAnBA,GAAAA,CAAvB,SAAuBA,CAAvB;;AAEA,UAAI,CAAJ,gBAAA,EAAuB;AACrBM,QAAAA,gBAAgB,GAAIJ,0BAAAA,OAAD,EAAgC;AACjD,cAAI,CAACC,cAAc,CAAnB,OAAmB,CAAnB,EAA8B;AAC5B;AACD;;AAHgD,8BAMzBD,OAAO,CAA/B,IANiD;AAAA,cAM3C,IAN2C,iBAM3C,IAN2C;AAAA,cAMpCE,OANoC,iBAMpCA,OANoC;AAOjDC,UAAAA,SAAS,CAAA,IAAA,EAATA,OAAS,CAATA;AAPFC,SAAAA;AASD;;AAGDL,MAAAA,IAAI,CAAJA,gBAAAA,CAAAA,SAAAA,EAAAA,gBAAAA;AACD;;;wCAEyB,S,EAExB;AACA,UAAMK,gBAAgB,GAAGN,mBAAmB,CAAnBA,GAAAA,CAAzB,SAAyBA,CAAzB;AACAA,MAAAA,mBAAmB,CAAnBA,MAAAA,CAAAA,SAAAA;AAEAC,MAAAA,IAAI,CAAJA,mBAAAA,CAAAA,SAAAA,EAAAA,gBAAAA;AACD;;;gCAOiB,I,EAAA,O,EAA+D;AAC/E,UAAA,IAAA,EAAU;AACR,YAAMM,IAAuB,GAAG;AAACC,UAAAA,MAAM,EAAP,YAAA;AAAuBC,UAAAA,IAAvB,EAAuBA,IAAvB;AAA6BL,UAAAA,OAAAA,EAAAA;AAA7B,SAAhC;AACA,YAAMM,YAAY,GAAGC,eAAe,CAApC,OAAoC,CAApC;AAGAV,QAAAA,IAAI,CAAJA,WAAAA,CAAAA,IAAAA,EAAAA,YAAAA;AACD;AACF;;;sBAxDmB,S,EAA6E;AAE/FA,MAAAA,IAAI,CAAJA,SAAAA,GAAkBC,UAAAA,OAAD,EAAa;AAC5B,YAAI,CAACC,cAAc,CAAnB,OAAmB,CAAnB,EAA8B;AAC5B;AACD;;AAH2B,6BAMJD,OAAO,CAA/B,IAN4B;AAAA,YAMtB,IANsB,kBAMtB,IANsB;AAAA,YAMfE,OANe,kBAMfA,OANe;AAO5BC,QAAAA,SAAS,CAAA,IAAA,EAATA,OAAS,CAATA;AAPFJ,OAAAA;AASD;;;;;;SAfY,U;;AAgEf,SAAA,cAAA,CAAA,OAAA,EAAoD;AAAA,MAC5C,IAD4C,GAClD,OADkD,CAC5C,IAD4C;AAAA,MACrCM,IADqC,GAClD,OADkD,CACrCA,IADqC;AAElD,SACEE,IAAI,KAAJA,SAAAA,IAAAA,IAAAA,IAEA,OAAOF,IAAI,CAAX,MAAA,KAFAE,QAAAA,IAGAF,IAAI,CAAJA,MAAAA,CAAAA,UAAAA,CAJF,YAIEA,CAJF;AAMD","sourcesContent":["import type {WorkerMessageData, WorkerMessageType, WorkerMessagePayload} from '../../types';\nimport {getTransferList} from '../worker-utils/get-transfer-list';\n\nconst onMessageWrapperMap = new Map();\n\n/**\n * Type safe wrapper for worker code\n */\nexport default class WorkerBody {\n  /*\n   * (type: WorkerMessageType, payload: WorkerMessagePayload) => any\n   */\n  static set onmessage(onMessage: (type: WorkerMessageType, payload: WorkerMessagePayload) => any) {\n    // eslint-disable-next-line no-restricted-globals\n    self.onmessage = (message) => {\n      if (!isKnownMessage(message)) {\n        return;\n      }\n\n      // Confusingly the message itself also has a 'type' field which is always set to 'message'\n      const {type, payload} = message.data;\n      onMessage(type, payload);\n    };\n  }\n\n  static addEventListener(\n    onMessage: (type: WorkerMessageType, payload: WorkerMessagePayload) => any\n  ) {\n    let onMessageWrapper = onMessageWrapperMap.get(onMessage);\n\n    if (!onMessageWrapper) {\n      onMessageWrapper = (message: MessageEvent<any>) => {\n        if (!isKnownMessage(message)) {\n          return;\n        }\n\n        // Confusingly the message itself also has a 'type' field which is always set to 'message'\n        const {type, payload} = message.data;\n        onMessage(type, payload);\n      };\n    }\n\n    // eslint-disable-next-line no-restricted-globals\n    self.addEventListener('message', onMessageWrapper);\n  }\n\n  static removeEventListener(\n    onMessage: (type: WorkerMessageType, payload: WorkerMessagePayload) => any\n  ) {\n    const onMessageWrapper = onMessageWrapperMap.get(onMessage);\n    onMessageWrapperMap.delete(onMessage);\n    // eslint-disable-next-line no-restricted-globals\n    self.removeEventListener('message', onMessageWrapper);\n  }\n\n  /**\n   * Send a message from a worker to creating thread (main thread)\n   * @param type\n   * @param payload\n   */\n  static postMessage(type: WorkerMessageType, payload: WorkerMessagePayload): void {\n    if (self) {\n      const data: WorkerMessageData = {source: 'loaders.gl', type, payload};\n      const transferList = getTransferList(payload);\n      // eslint-disable-next-line no-restricted-globals\n      // @ts-ignore\n      self.postMessage(data, transferList);\n    }\n  }\n}\n\n// Filter out noise messages sent to workers\nfunction isKnownMessage(message: MessageEvent<any>) {\n  const {type, data} = message;\n  return (\n    type === 'message' &&\n    data &&\n    typeof data.source === 'string' &&\n    data.source.startsWith('loaders.gl')\n  );\n}\n"]},"metadata":{},"sourceType":"module"}