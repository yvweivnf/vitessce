{"ast":null,"code":"/* eslint-disable no-underscore-dangle */\nimport GL from '@luma.gl/constants'; // eslint-disable-line import/no-extraneous-dependencies\n\nimport { _mergeShaders, project32, picking } from '@deck.gl/core'; // eslint-disable-line import/no-extraneous-dependencies\n\nimport { BitmapLayer } from '@deck.gl/layers'; // eslint-disable-line import/no-extraneous-dependencies\n\nimport { Texture2D } from '@luma.gl/core';\nimport { PIXELATED_TEXTURE_PARAMETERS, TILE_SIZE, DATA_TEXTURE_SIZE } from './heatmap-constants';\nimport { GLSL_COLORMAPS, GLSL_COLORMAP_DEFAULT, COLORMAP_SHADER_PLACEHOLDER } from './constants';\nimport { vertexShader, fragmentShader } from './padded-expression-heatmap-bitmap-layer-shaders';\nconst defaultProps = {\n  image: {\n    type: 'object',\n    value: null,\n    async: true\n  },\n  colormap: {\n    type: 'string',\n    value: GLSL_COLORMAP_DEFAULT,\n    compare: true\n  },\n  bounds: {\n    type: 'array',\n    value: [1, 0, 0, 1],\n    compare: true\n  },\n  aggSizeX: {\n    type: 'number',\n    value: 8.0,\n    compare: true\n  },\n  aggSizeY: {\n    type: 'number',\n    value: 8.0,\n    compare: true\n  },\n  colorScaleLo: {\n    type: 'number',\n    value: 0.0,\n    compare: true\n  },\n  colorScaleHi: {\n    type: 'number',\n    value: 1.0,\n    compare: true\n  }\n};\n/**\n * A BitmapLayer that performs aggregation in the fragment shader,\n * and renders its texture from a Uint8Array rather than an ImageData.\n */\n\nexport default class PaddedExpressionHeatmapBitmapLayer extends BitmapLayer {\n  /**\n   * Copy of getShaders from Layer (grandparent, parent of BitmapLayer).\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/core/src/lib/layer.js#L302\n   * @param {object} shaders\n   * @returns {object} Merged shaders.\n   */\n  _getShaders(shaders) {\n    this.props.extensions.forEach(extension => {\n      // eslint-disable-next-line no-param-reassign\n      shaders = _mergeShaders(shaders, extension.getShaders.call(this, extension));\n    });\n    return shaders;\n  }\n  /**\n   * Need to override to provide custom shaders.\n   */\n\n\n  getShaders() {\n    const {\n      colormap\n    } = this.props;\n    const fragmentShaderWithColormap = GLSL_COLORMAPS.includes(colormap) ? fragmentShader.replace(COLORMAP_SHADER_PLACEHOLDER, colormap) : fragmentShader.replace(COLORMAP_SHADER_PLACEHOLDER, GLSL_COLORMAP_DEFAULT);\n    return this._getShaders({\n      vs: vertexShader,\n      fs: fragmentShaderWithColormap,\n      modules: [project32, picking]\n    });\n  }\n\n  updateState(args) {\n    super.updateState(args);\n    const {\n      props,\n      oldProps\n    } = args;\n\n    if (props.colormap !== oldProps.colormap) {\n      var _this$state$model;\n\n      const {\n        gl\n      } = this.context; // eslint-disable-next-line no-unused-expressions\n\n      (_this$state$model = this.state.model) === null || _this$state$model === void 0 ? void 0 : _this$state$model.delete();\n      this.state.model = this._getModel(gl);\n      this.getAttributeManager().invalidateAll();\n    }\n\n    if (props.image !== oldProps.image) {\n      this.loadTexture(this.props.image);\n    }\n  }\n  /**\n   * Need to override to provide additional uniform values.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L173\n   * @param {*} opts\n   */\n\n\n  draw(opts) {\n    const {\n      uniforms\n    } = opts;\n    const {\n      bitmapTexture,\n      model\n    } = this.state;\n    const {\n      aggSizeX,\n      aggSizeY,\n      colorScaleLo,\n      colorScaleHi,\n      origDataSize,\n      tileI,\n      tileJ,\n      numXTiles,\n      numYTiles\n    } = this.props; // Render the image\n\n    if (bitmapTexture && model) {\n      model.setUniforms(Object.assign({}, uniforms, {\n        uBitmapTexture: bitmapTexture,\n        uOrigDataSize: origDataSize,\n        uReshapedDataSize: [DATA_TEXTURE_SIZE, DATA_TEXTURE_SIZE],\n        uTextureSize: [TILE_SIZE, TILE_SIZE],\n        uAggSize: [aggSizeX, aggSizeY],\n        uColorScaleRange: [colorScaleLo, colorScaleHi],\n        tileIJ: [tileI, tileJ],\n        dataIJ: [0, 0],\n        numTiles: [numXTiles, numYTiles],\n        numData: [1, 1]\n      })).draw();\n    }\n  }\n  /**\n   * Need to override to provide the custom DEFAULT_TEXTURE_PARAMETERS\n   * object.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L218\n   * @param {Array<Uint8Array>} images\n   */\n\n\n  loadTexture(image) {\n    const {\n      gl\n    } = this.context;\n\n    if (this.state.bitmapTexture) {\n      this.state.bitmapTexture.delete();\n    }\n\n    if (image && image instanceof Texture2D) {\n      this.setState({\n        bitmapTexture: image\n      });\n    } else if (image) {\n      this.setState({\n        bitmapTexture: new Texture2D(gl, {\n          data: image,\n          mipmaps: false,\n          parameters: PIXELATED_TEXTURE_PARAMETERS,\n          // Each color contains a single luminance value.\n          // When sampled, rgb are all set to this luminance, alpha is 1.0.\n          // Reference: https://luma.gl/docs/api-reference/webgl/texture#texture-formats\n          format: GL.LUMINANCE,\n          dataFormat: GL.LUMINANCE,\n          type: GL.UNSIGNED_BYTE,\n          width: DATA_TEXTURE_SIZE,\n          height: DATA_TEXTURE_SIZE\n        })\n      });\n    }\n  }\n\n}\nPaddedExpressionHeatmapBitmapLayer.layerName = 'PaddedExpressionHeatmapBitmapLayer';\nPaddedExpressionHeatmapBitmapLayer.defaultProps = defaultProps;","map":{"version":3,"sources":["C:/Users/wkuo/Documents/vitessce-forked-v1.2.2/vitessce/src/layers/PaddedExpressionHeatmapBitmapLayer.js"],"names":["GL","_mergeShaders","project32","picking","BitmapLayer","Texture2D","PIXELATED_TEXTURE_PARAMETERS","TILE_SIZE","DATA_TEXTURE_SIZE","GLSL_COLORMAPS","GLSL_COLORMAP_DEFAULT","COLORMAP_SHADER_PLACEHOLDER","vertexShader","fragmentShader","defaultProps","image","type","value","async","colormap","compare","bounds","aggSizeX","aggSizeY","colorScaleLo","colorScaleHi","PaddedExpressionHeatmapBitmapLayer","_getShaders","shaders","props","extensions","forEach","extension","getShaders","call","fragmentShaderWithColormap","includes","replace","vs","fs","modules","updateState","args","oldProps","gl","context","state","model","delete","_getModel","getAttributeManager","invalidateAll","loadTexture","draw","opts","uniforms","bitmapTexture","origDataSize","tileI","tileJ","numXTiles","numYTiles","setUniforms","Object","assign","uBitmapTexture","uOrigDataSize","uReshapedDataSize","uTextureSize","uAggSize","uColorScaleRange","tileIJ","dataIJ","numTiles","numData","setState","data","mipmaps","parameters","format","LUMINANCE","dataFormat","UNSIGNED_BYTE","width","height","layerName"],"mappings":"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","sourcesContent":["/* eslint-disable no-underscore-dangle */\nimport GL from '@luma.gl/constants'; // eslint-disable-line import/no-extraneous-dependencies\nimport { _mergeShaders, project32, picking } from '@deck.gl/core'; // eslint-disable-line import/no-extraneous-dependencies\nimport { BitmapLayer } from '@deck.gl/layers'; // eslint-disable-line import/no-extraneous-dependencies\nimport { Texture2D } from '@luma.gl/core';\nimport { PIXELATED_TEXTURE_PARAMETERS, TILE_SIZE, DATA_TEXTURE_SIZE } from './heatmap-constants';\nimport { GLSL_COLORMAPS, GLSL_COLORMAP_DEFAULT, COLORMAP_SHADER_PLACEHOLDER } from './constants';\nimport { vertexShader, fragmentShader } from './padded-expression-heatmap-bitmap-layer-shaders';\n\nconst defaultProps = {\n  image: { type: 'object', value: null, async: true },\n  colormap: { type: 'string', value: GLSL_COLORMAP_DEFAULT, compare: true },\n  bounds: { type: 'array', value: [1, 0, 0, 1], compare: true },\n  aggSizeX: { type: 'number', value: 8.0, compare: true },\n  aggSizeY: { type: 'number', value: 8.0, compare: true },\n  colorScaleLo: { type: 'number', value: 0.0, compare: true },\n  colorScaleHi: { type: 'number', value: 1.0, compare: true },\n};\n\n/**\n * A BitmapLayer that performs aggregation in the fragment shader,\n * and renders its texture from a Uint8Array rather than an ImageData.\n */\nexport default class PaddedExpressionHeatmapBitmapLayer extends BitmapLayer {\n  /**\n   * Copy of getShaders from Layer (grandparent, parent of BitmapLayer).\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/core/src/lib/layer.js#L302\n   * @param {object} shaders\n   * @returns {object} Merged shaders.\n   */\n  _getShaders(shaders) {\n    this.props.extensions.forEach((extension) => {\n      // eslint-disable-next-line no-param-reassign\n      shaders = _mergeShaders(\n        shaders,\n        extension.getShaders.call(this, extension),\n      );\n    });\n    return shaders;\n  }\n\n  /**\n   * Need to override to provide custom shaders.\n   */\n  getShaders() {\n    const { colormap } = this.props;\n    const fragmentShaderWithColormap = GLSL_COLORMAPS.includes(colormap)\n      ? fragmentShader.replace(COLORMAP_SHADER_PLACEHOLDER, colormap)\n      : fragmentShader.replace(\n        COLORMAP_SHADER_PLACEHOLDER,\n        GLSL_COLORMAP_DEFAULT,\n      );\n    return this._getShaders({\n      vs: vertexShader,\n      fs: fragmentShaderWithColormap,\n      modules: [project32, picking],\n    });\n  }\n\n  updateState(args) {\n    super.updateState(args);\n    const { props, oldProps } = args;\n    if (props.colormap !== oldProps.colormap) {\n      const { gl } = this.context;\n      // eslint-disable-next-line no-unused-expressions\n      this.state.model?.delete();\n      this.state.model = this._getModel(gl);\n      this.getAttributeManager().invalidateAll();\n    }\n    if (props.image !== oldProps.image) {\n      this.loadTexture(this.props.image);\n    }\n  }\n\n  /**\n   * Need to override to provide additional uniform values.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L173\n   * @param {*} opts\n   */\n  draw(opts) {\n    const { uniforms } = opts;\n    const { bitmapTexture, model } = this.state;\n    const {\n      aggSizeX,\n      aggSizeY,\n      colorScaleLo,\n      colorScaleHi,\n      origDataSize,\n      tileI,\n      tileJ,\n      numXTiles,\n      numYTiles,\n    } = this.props;\n    // Render the image\n    if (bitmapTexture && model) {\n      model\n        .setUniforms(\n          Object.assign({}, uniforms, {\n            uBitmapTexture: bitmapTexture,\n            uOrigDataSize: origDataSize,\n            uReshapedDataSize: [DATA_TEXTURE_SIZE, DATA_TEXTURE_SIZE],\n            uTextureSize: [TILE_SIZE, TILE_SIZE],\n            uAggSize: [aggSizeX, aggSizeY],\n            uColorScaleRange: [colorScaleLo, colorScaleHi],\n            tileIJ: [tileI, tileJ],\n            dataIJ: [0, 0],\n            numTiles: [numXTiles, numYTiles],\n            numData: [1, 1],\n          }),\n        )\n        .draw();\n    }\n  }\n\n  /**\n   * Need to override to provide the custom DEFAULT_TEXTURE_PARAMETERS\n   * object.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L218\n   * @param {Array<Uint8Array>} images\n   */\n  loadTexture(image) {\n    const { gl } = this.context;\n\n    if (this.state.bitmapTexture) {\n      this.state.bitmapTexture.delete();\n    }\n\n    if (image && image instanceof Texture2D) {\n      this.setState({\n        bitmapTexture: image,\n      });\n    } else if (image) {\n      this.setState({\n        bitmapTexture: new Texture2D(gl, {\n          data: image,\n          mipmaps: false,\n          parameters: PIXELATED_TEXTURE_PARAMETERS,\n          // Each color contains a single luminance value.\n          // When sampled, rgb are all set to this luminance, alpha is 1.0.\n          // Reference: https://luma.gl/docs/api-reference/webgl/texture#texture-formats\n          format: GL.LUMINANCE,\n          dataFormat: GL.LUMINANCE,\n          type: GL.UNSIGNED_BYTE,\n          width: DATA_TEXTURE_SIZE,\n          height: DATA_TEXTURE_SIZE,\n        }),\n      });\n    }\n  }\n}\nPaddedExpressionHeatmapBitmapLayer.layerName = 'PaddedExpressionHeatmapBitmapLayer';\nPaddedExpressionHeatmapBitmapLayer.defaultProps = defaultProps;\n"]},"metadata":{},"sourceType":"module"}