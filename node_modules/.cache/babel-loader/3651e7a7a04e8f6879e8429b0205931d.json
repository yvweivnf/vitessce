{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _core = require(\"@deck.gl/core\");\n\nfunction _typeof(obj) {\n  \"@babel/helpers - typeof\";\n\n  if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n\n  return _typeof(obj);\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    if (enumerableOnly) symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    });\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nfunction _createForOfIteratorHelper(o) {\n  if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) {\n    if (Array.isArray(o) || (o = _unsupportedIterableToArray(o))) {\n      var i = 0;\n\n      var F = function F() {};\n\n      return {\n        s: F,\n        n: function n() {\n          if (i >= o.length) return {\n            done: true\n          };\n          return {\n            done: false,\n            value: o[i++]\n          };\n        },\n        e: function e(_e) {\n          throw _e;\n        },\n        f: F\n      };\n    }\n\n    throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n  }\n\n  var it,\n      normalCompletion = true,\n      didErr = false,\n      err;\n  return {\n    s: function s() {\n      it = o[Symbol.iterator]();\n    },\n    n: function n() {\n      var step = it.next();\n      normalCompletion = step.done;\n      return step;\n    },\n    e: function e(_e2) {\n      didErr = true;\n      err = _e2;\n    },\n    f: function f() {\n      try {\n        if (!normalCompletion && it[\"return\"] != null) it[\"return\"]();\n      } finally {\n        if (didErr) throw err;\n      }\n    }\n  };\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(n);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nfunction _createSuper(Derived) {\n  return function () {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (_isNativeReflectConstruct()) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) {\n    return call;\n  }\n\n  return _assertThisInitialized(self);\n}\n\nfunction _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return self;\n}\n\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) _setPrototypeOf(subClass, superClass);\n}\n\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n\n  return _setPrototypeOf(o, p);\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nvar EVENT_TYPES = ['anyclick', 'pointermove', 'panstart', 'panmove', 'panend', 'keyup'];\n\nvar EditableLayer = /*#__PURE__*/function (_CompositeLayer) {\n  _inherits(EditableLayer, _CompositeLayer);\n\n  var _super = _createSuper(EditableLayer);\n\n  function EditableLayer() {\n    _classCallCheck(this, EditableLayer);\n\n    return _super.apply(this, arguments);\n  }\n\n  _createClass(EditableLayer, [{\n    key: \"onLayerClick\",\n    // Overridable interaction event handlers\n    value: function onLayerClick(event) {// default implementation - do nothing\n    }\n  }, {\n    key: \"onStartDragging\",\n    value: function onStartDragging(event) {// default implementation - do nothing\n    }\n  }, {\n    key: \"onStopDragging\",\n    value: function onStopDragging(event) {// default implementation - do nothing\n    }\n  }, {\n    key: \"onDragging\",\n    value: function onDragging(event) {// default implementation - do nothing\n    }\n  }, {\n    key: \"onPointerMove\",\n    value: function onPointerMove(event) {// default implementation - do nothing\n    }\n  }, {\n    key: \"onLayerKeyUp\",\n    value: function onLayerKeyUp(event) {} // default implementation - do nothing;\n    // TODO: implement onCancelDragging (e.g. drag off screen)\n\n  }, {\n    key: \"initializeState\",\n    value: function initializeState() {\n      this.setState({\n        _editableLayerState: {\n          // Picked objects at the time the pointer went down\n          pointerDownPicks: null,\n          // Screen coordinates where the pointer went down\n          pointerDownScreenCoords: null,\n          // Ground coordinates where the pointer went down\n          pointerDownMapCoords: null,\n          // Keep track of the mjolnir.js event handler so it can be deregistered\n          eventHandler: this._forwardEventToCurrentLayer.bind(this)\n        }\n      });\n\n      this._addEventHandlers();\n    }\n  }, {\n    key: \"finalizeState\",\n    value: function finalizeState() {\n      this._removeEventHandlers();\n    }\n  }, {\n    key: \"_addEventHandlers\",\n    value: function _addEventHandlers() {\n      // @ts-ignore\n      var eventManager = this.context.deck.eventManager;\n      var eventHandler = this.state._editableLayerState.eventHandler;\n\n      var _iterator = _createForOfIteratorHelper(EVENT_TYPES),\n          _step;\n\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var eventType = _step.value;\n          eventManager.on(eventType, eventHandler, {\n            // give nebula a higher priority so that it can stop propagation to deck.gl's map panning handlers\n            priority: 100\n          });\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n    }\n  }, {\n    key: \"_removeEventHandlers\",\n    value: function _removeEventHandlers() {\n      // @ts-ignore\n      var eventManager = this.context.deck.eventManager;\n      var eventHandler = this.state._editableLayerState.eventHandler;\n\n      var _iterator2 = _createForOfIteratorHelper(EVENT_TYPES),\n          _step2;\n\n      try {\n        for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n          var eventType = _step2.value;\n          eventManager.off(eventType, eventHandler);\n        }\n      } catch (err) {\n        _iterator2.e(err);\n      } finally {\n        _iterator2.f();\n      }\n    } // A new layer instance is created on every render, so forward the event to the current layer\n    // This means that the first layer instance will stick around to be the event listener, but will forward the event\n    // to the latest layer instance.\n\n  }, {\n    key: \"_forwardEventToCurrentLayer\",\n    value: function _forwardEventToCurrentLayer(event) {\n      var currentLayer = this.getCurrentLayer(); // Use a naming convention to find the event handling function for this event type\n\n      var func = currentLayer[\"_on\".concat(event.type)].bind(currentLayer);\n\n      if (!func) {\n        console.warn(\"no handler for mjolnir.js event \".concat(event.type)); // eslint-disable-line\n\n        return;\n      }\n\n      func(event);\n    }\n  }, {\n    key: \"_onanyclick\",\n    value: function _onanyclick(_ref) {\n      var srcEvent = _ref.srcEvent;\n      var screenCoords = this.getScreenCoords(srcEvent);\n      var mapCoords = this.getMapCoords(screenCoords); // @ts-ignore\n\n      var picks = this.getPicks(screenCoords);\n      this.onLayerClick({\n        mapCoords: mapCoords,\n        // @ts-ignore\n        screenCoords: screenCoords,\n        picks: picks,\n        sourceEvent: srcEvent\n      });\n    }\n  }, {\n    key: \"_onkeyup\",\n    value: function _onkeyup(_ref2) {\n      var srcEvent = _ref2.srcEvent;\n      this.onLayerKeyUp(srcEvent);\n    }\n  }, {\n    key: \"_onpanstart\",\n    value: function _onpanstart(event) {\n      var screenCoords = this.getScreenCoords(event.srcEvent);\n      var mapCoords = this.getMapCoords(screenCoords); // @ts-ignore\n\n      var picks = this.getPicks(screenCoords);\n      this.setState({\n        _editableLayerState: _objectSpread({}, this.state._editableLayerState, {\n          pointerDownScreenCoords: screenCoords,\n          pointerDownMapCoords: mapCoords,\n          pointerDownPicks: picks\n        })\n      });\n      this.onStartDragging({\n        picks: picks,\n        // @ts-ignore\n        screenCoords: screenCoords,\n        // @ts-ignore\n        mapCoords: mapCoords,\n        // @ts-ignore\n        pointerDownScreenCoords: screenCoords,\n        pointerDownMapCoords: mapCoords,\n        cancelPan: event.stopImmediatePropagation,\n        sourceEvent: event.srcEvent\n      });\n    }\n  }, {\n    key: \"_onpanmove\",\n    value: function _onpanmove(event) {\n      var srcEvent = event.srcEvent;\n      var screenCoords = this.getScreenCoords(srcEvent);\n      var mapCoords = this.getMapCoords(screenCoords);\n      var _this$state$_editable = this.state._editableLayerState,\n          pointerDownPicks = _this$state$_editable.pointerDownPicks,\n          pointerDownScreenCoords = _this$state$_editable.pointerDownScreenCoords,\n          pointerDownMapCoords = _this$state$_editable.pointerDownMapCoords; // @ts-ignore\n\n      var picks = this.getPicks(screenCoords);\n      this.onDragging({\n        // @ts-ignore\n        screenCoords: screenCoords,\n        mapCoords: mapCoords,\n        picks: picks,\n        pointerDownPicks: pointerDownPicks,\n        pointerDownScreenCoords: pointerDownScreenCoords,\n        pointerDownMapCoords: pointerDownMapCoords,\n        sourceEvent: srcEvent,\n        cancelPan: event.stopImmediatePropagation // another (hacky) approach for cancelling map panning\n        // const controller = this.context.deck.viewManager.controllers[\n        //   Object.keys(this.context.deck.viewManager.controllers)[0]\n        // ];\n        // controller._state.isDragging = false;\n\n      });\n    }\n  }, {\n    key: \"_onpanend\",\n    value: function _onpanend(_ref3) {\n      var srcEvent = _ref3.srcEvent;\n      var screenCoords = this.getScreenCoords(srcEvent);\n      var mapCoords = this.getMapCoords(screenCoords);\n      var _this$state$_editable2 = this.state._editableLayerState,\n          pointerDownPicks = _this$state$_editable2.pointerDownPicks,\n          pointerDownScreenCoords = _this$state$_editable2.pointerDownScreenCoords,\n          pointerDownMapCoords = _this$state$_editable2.pointerDownMapCoords; // @ts-ignore\n\n      var picks = this.getPicks(screenCoords);\n      this.onStopDragging({\n        picks: picks,\n        // @ts-ignore\n        screenCoords: screenCoords,\n        mapCoords: mapCoords,\n        pointerDownPicks: pointerDownPicks,\n        pointerDownScreenCoords: pointerDownScreenCoords,\n        pointerDownMapCoords: pointerDownMapCoords,\n        sourceEvent: srcEvent\n      });\n      this.setState({\n        _editableLayerState: _objectSpread({}, this.state._editableLayerState, {\n          pointerDownScreenCoords: null,\n          pointerDownMapCoords: null,\n          pointerDownPicks: null\n        })\n      });\n    }\n  }, {\n    key: \"_onpointermove\",\n    value: function _onpointermove(event) {\n      var srcEvent = event.srcEvent;\n      var screenCoords = this.getScreenCoords(srcEvent);\n      var mapCoords = this.getMapCoords(screenCoords);\n      var _this$state$_editable3 = this.state._editableLayerState,\n          pointerDownPicks = _this$state$_editable3.pointerDownPicks,\n          pointerDownScreenCoords = _this$state$_editable3.pointerDownScreenCoords,\n          pointerDownMapCoords = _this$state$_editable3.pointerDownMapCoords; // @ts-ignore\n\n      var picks = this.getPicks(screenCoords);\n      this.onPointerMove({\n        // @ts-ignore\n        screenCoords: screenCoords,\n        mapCoords: mapCoords,\n        picks: picks,\n        pointerDownPicks: pointerDownPicks,\n        pointerDownScreenCoords: pointerDownScreenCoords,\n        pointerDownMapCoords: pointerDownMapCoords,\n        sourceEvent: srcEvent\n      });\n    }\n  }, {\n    key: \"getPicks\",\n    value: function getPicks(screenCoords) {\n      // @ts-ignore\n      return this.context.deck.pickMultipleObjects({\n        x: screenCoords[0],\n        y: screenCoords[1],\n        layerIds: [this.props.id],\n        radius: this.props.pickingRadius,\n        depth: this.props.pickingDepth\n      });\n    }\n  }, {\n    key: \"getScreenCoords\",\n    value: function getScreenCoords(pointerEvent) {\n      return [pointerEvent.clientX - this.context.gl.canvas.getBoundingClientRect().left, pointerEvent.clientY - this.context.gl.canvas.getBoundingClientRect().top];\n    }\n  }, {\n    key: \"getMapCoords\",\n    value: function getMapCoords(screenCoords) {\n      // @ts-ignore\n      return this.context.viewport.unproject([screenCoords[0], screenCoords[1]]);\n    }\n  }]);\n\n  return EditableLayer;\n}(_core.CompositeLayer);\n\nexports[\"default\"] = EditableLayer;\n\n_defineProperty(EditableLayer, \"layerName\", 'EditableLayer');","map":{"version":3,"sources":["../../src/layers/editable-layer.ts"],"names":["EVENT_TYPES","EditableLayer","CompositeLayer","event","_editableLayerState","pointerDownPicks","pointerDownScreenCoords","pointerDownMapCoords","eventHandler","eventManager","eventType","priority","currentLayer","func","console","srcEvent","screenCoords","mapCoords","picks","sourceEvent","cancelPan","x","y","layerIds","radius","depth","pickingDepth","pointerEvent"],"mappings":"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","sourcesContent":["/* eslint-env browser */\n\nimport { CompositeLayer } from '@deck.gl/core';\nimport {\n  ClickEvent,\n  StartDraggingEvent,\n  StopDraggingEvent,\n  DraggingEvent,\n  PointerMoveEvent,\n} from '@nebula.gl/edit-modes';\n\nconst EVENT_TYPES = ['anyclick', 'pointermove', 'panstart', 'panmove', 'panend', 'keyup'];\n\nexport default class EditableLayer extends CompositeLayer<any> {\n  static layerName = 'EditableLayer';\n  // Overridable interaction event handlers\n  onLayerClick(event: ClickEvent) {\n    // default implementation - do nothing\n  }\n\n  onStartDragging(event: StartDraggingEvent) {\n    // default implementation - do nothing\n  }\n\n  onStopDragging(event: StopDraggingEvent) {\n    // default implementation - do nothing\n  }\n\n  onDragging(event: DraggingEvent) {\n    // default implementation - do nothing\n  }\n\n  onPointerMove(event: PointerMoveEvent) {\n    // default implementation - do nothing\n  }\n\n  onLayerKeyUp(event: KeyboardEvent): void {\n    // default implementation - do nothing;\n  }\n  // TODO: implement onCancelDragging (e.g. drag off screen)\n\n  initializeState() {\n    this.setState({\n      _editableLayerState: {\n        // Picked objects at the time the pointer went down\n        pointerDownPicks: null,\n        // Screen coordinates where the pointer went down\n        pointerDownScreenCoords: null,\n        // Ground coordinates where the pointer went down\n        pointerDownMapCoords: null,\n\n        // Keep track of the mjolnir.js event handler so it can be deregistered\n        eventHandler: this._forwardEventToCurrentLayer.bind(this),\n      },\n    });\n\n    this._addEventHandlers();\n  }\n\n  finalizeState() {\n    this._removeEventHandlers();\n  }\n\n  _addEventHandlers() {\n    // @ts-ignore\n    const { eventManager } = this.context.deck;\n    const { eventHandler } = this.state._editableLayerState;\n\n    for (const eventType of EVENT_TYPES) {\n      eventManager.on(eventType, eventHandler, {\n        // give nebula a higher priority so that it can stop propagation to deck.gl's map panning handlers\n        priority: 100,\n      });\n    }\n  }\n\n  _removeEventHandlers() {\n    // @ts-ignore\n    const { eventManager } = this.context.deck;\n    const { eventHandler } = this.state._editableLayerState;\n\n    for (const eventType of EVENT_TYPES) {\n      eventManager.off(eventType, eventHandler);\n    }\n  }\n\n  // A new layer instance is created on every render, so forward the event to the current layer\n  // This means that the first layer instance will stick around to be the event listener, but will forward the event\n  // to the latest layer instance.\n  _forwardEventToCurrentLayer(event: any) {\n    const currentLayer = this.getCurrentLayer();\n\n    // Use a naming convention to find the event handling function for this event type\n    const func = currentLayer[`_on${event.type}`].bind(currentLayer);\n    if (!func) {\n      console.warn(`no handler for mjolnir.js event ${event.type}`); // eslint-disable-line\n      return;\n    }\n    func(event);\n  }\n\n  _onanyclick({ srcEvent }: any) {\n    const screenCoords = this.getScreenCoords(srcEvent);\n    const mapCoords = this.getMapCoords(screenCoords);\n    // @ts-ignore\n    const picks = this.getPicks(screenCoords);\n\n    this.onLayerClick({\n      mapCoords,\n      // @ts-ignore\n      screenCoords,\n      picks,\n      sourceEvent: srcEvent,\n    });\n  }\n\n  _onkeyup({ srcEvent }: { srcEvent: KeyboardEvent }) {\n    this.onLayerKeyUp(srcEvent);\n  }\n\n  _onpanstart(event: any) {\n    const screenCoords = this.getScreenCoords(event.srcEvent);\n    const mapCoords = this.getMapCoords(screenCoords);\n    // @ts-ignore\n    const picks = this.getPicks(screenCoords);\n\n    this.setState({\n      _editableLayerState: {\n        ...this.state._editableLayerState,\n        pointerDownScreenCoords: screenCoords,\n        pointerDownMapCoords: mapCoords,\n        pointerDownPicks: picks,\n      },\n    });\n\n    this.onStartDragging({\n      picks,\n      // @ts-ignore\n      screenCoords,\n      // @ts-ignore\n      mapCoords,\n      // @ts-ignore\n      pointerDownScreenCoords: screenCoords,\n      pointerDownMapCoords: mapCoords,\n      cancelPan: event.stopImmediatePropagation,\n      sourceEvent: event.srcEvent,\n    });\n  }\n\n  _onpanmove(event: any) {\n    const { srcEvent } = event;\n    const screenCoords = this.getScreenCoords(srcEvent);\n    const mapCoords = this.getMapCoords(screenCoords);\n\n    const {\n      pointerDownPicks,\n      pointerDownScreenCoords,\n      pointerDownMapCoords,\n    } = this.state._editableLayerState;\n    // @ts-ignore\n    const picks = this.getPicks(screenCoords);\n\n    this.onDragging({\n      // @ts-ignore\n      screenCoords,\n      mapCoords,\n      picks,\n      pointerDownPicks,\n      pointerDownScreenCoords,\n      pointerDownMapCoords,\n      sourceEvent: srcEvent,\n      cancelPan: event.stopImmediatePropagation,\n      // another (hacky) approach for cancelling map panning\n      // const controller = this.context.deck.viewManager.controllers[\n      //   Object.keys(this.context.deck.viewManager.controllers)[0]\n      // ];\n      // controller._state.isDragging = false;\n    });\n  }\n\n  _onpanend({ srcEvent }: any) {\n    const screenCoords = this.getScreenCoords(srcEvent);\n    const mapCoords = this.getMapCoords(screenCoords);\n\n    const {\n      pointerDownPicks,\n      pointerDownScreenCoords,\n      pointerDownMapCoords,\n    } = this.state._editableLayerState;\n    // @ts-ignore\n    const picks = this.getPicks(screenCoords);\n\n    this.onStopDragging({\n      picks,\n      // @ts-ignore\n      screenCoords,\n      mapCoords,\n      pointerDownPicks,\n      pointerDownScreenCoords,\n      pointerDownMapCoords,\n      sourceEvent: srcEvent,\n    });\n\n    this.setState({\n      _editableLayerState: {\n        ...this.state._editableLayerState,\n        pointerDownScreenCoords: null,\n        pointerDownMapCoords: null,\n        pointerDownPicks: null,\n      },\n    });\n  }\n\n  _onpointermove(event: any) {\n    const { srcEvent } = event;\n    const screenCoords = this.getScreenCoords(srcEvent);\n    const mapCoords = this.getMapCoords(screenCoords);\n\n    const {\n      pointerDownPicks,\n      pointerDownScreenCoords,\n      pointerDownMapCoords,\n    } = this.state._editableLayerState;\n    // @ts-ignore\n    const picks = this.getPicks(screenCoords);\n\n    this.onPointerMove({\n      // @ts-ignore\n      screenCoords,\n      mapCoords,\n      picks,\n      pointerDownPicks,\n      pointerDownScreenCoords,\n      pointerDownMapCoords,\n      sourceEvent: srcEvent,\n    });\n  }\n\n  getPicks(screenCoords: [number, number]) {\n    // @ts-ignore\n    return this.context.deck.pickMultipleObjects({\n      x: screenCoords[0],\n      y: screenCoords[1],\n      layerIds: [this.props.id],\n      radius: this.props.pickingRadius,\n      depth: this.props.pickingDepth,\n    });\n  }\n\n  getScreenCoords(pointerEvent: any) {\n    return [\n      pointerEvent.clientX -\n        (this.context.gl.canvas as HTMLCanvasElement).getBoundingClientRect().left,\n      pointerEvent.clientY -\n        (this.context.gl.canvas as HTMLCanvasElement).getBoundingClientRect().top,\n    ];\n  }\n\n  getMapCoords(screenCoords: number[]) {\n    // @ts-ignore\n    return this.context.viewport.unproject([screenCoords[0], screenCoords[1]]);\n  }\n}\n"]},"metadata":{},"sourceType":"script"}