{"ast":null,"code":"import { getViewConfigContinuousSize } from '../../config';\nimport { hasDiscreteDomain } from '../../scale';\nimport { getFirstDefined } from '../../util';\nimport { isVgRangeStep } from '../../vega.schema';\nimport { signalOrStringValue } from '../common';\nimport { isFacetModel } from '../model';\nexport function assembleLayoutSignals(model) {\n  return [...sizeSignals(model, 'width'), ...sizeSignals(model, 'height'), ...sizeSignals(model, 'childWidth'), ...sizeSignals(model, 'childHeight')];\n}\nexport function sizeSignals(model, sizeType) {\n  const channel = sizeType === 'width' ? 'x' : 'y';\n  const size = model.component.layoutSize.get(sizeType);\n\n  if (!size || size === 'merged') {\n    return [];\n  } // Read size signal name from name map, just in case it is the top-level size signal that got renamed.\n\n\n  const name = model.getSizeSignalRef(sizeType).signal;\n\n  if (size === 'step') {\n    const scaleComponent = model.getScaleComponent(channel);\n\n    if (scaleComponent) {\n      const type = scaleComponent.get('type');\n      const range = scaleComponent.get('range');\n\n      if (hasDiscreteDomain(type) && isVgRangeStep(range)) {\n        const scaleName = model.scaleName(channel);\n\n        if (isFacetModel(model.parent)) {\n          // If parent is facet and this is an independent scale, return only signal signal\n          // as the width/height will be calculated using the cardinality from\n          // facet's aggregate rather than reading from scale domain\n          const parentResolve = model.parent.component.resolve;\n\n          if (parentResolve.scale[channel] === 'independent') {\n            return [stepSignal(scaleName, range)];\n          }\n        }\n\n        return [stepSignal(scaleName, range), {\n          name,\n          update: sizeExpr(scaleName, scaleComponent, `domain('${scaleName}').length`)\n        }];\n      }\n    }\n    /* istanbul ignore next: Condition should not happen -- only for warning in development. */\n\n\n    throw new Error('layout size is step although width/height is not step.');\n  } else if (size == 'container') {\n    const isWidth = name.endsWith('width');\n    const expr = isWidth ? 'containerSize()[0]' : 'containerSize()[1]';\n    const defaultValue = getViewConfigContinuousSize(model.config.view, isWidth ? 'width' : 'height');\n    const safeExpr = `isFinite(${expr}) ? ${expr} : ${defaultValue}`;\n    return [{\n      name,\n      init: safeExpr,\n      on: [{\n        update: safeExpr,\n        events: 'window:resize'\n      }]\n    }];\n  } else {\n    return [{\n      name,\n      value: size\n    }];\n  }\n}\n\nfunction stepSignal(scaleName, range) {\n  return {\n    name: `${scaleName}_step`,\n    value: range.step\n  };\n}\n\nexport function sizeExpr(scaleName, scaleComponent, cardinality) {\n  const type = scaleComponent.get('type');\n  const padding = scaleComponent.get('padding');\n  const paddingOuter = getFirstDefined(scaleComponent.get('paddingOuter'), padding);\n  let paddingInner = scaleComponent.get('paddingInner');\n  paddingInner = type === 'band' ? // only band has real paddingInner\n  paddingInner !== undefined ? paddingInner : padding : // For point, as calculated in https://github.com/vega/vega-scale/blob/master/src/band.js#L128,\n  // it's equivalent to have paddingInner = 1 since there is only n-1 steps between n points.\n  1;\n  return `bandspace(${cardinality}, ${signalOrStringValue(paddingInner)}, ${signalOrStringValue(paddingOuter)}) * ${scaleName}_step`;\n}","map":{"version":3,"sources":["../../../../src/compile/layoutsize/assemble.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { getViewConfigContinuousSize } from '../../config';\nimport { hasDiscreteDomain } from '../../scale';\nimport { getFirstDefined } from '../../util';\nimport { isVgRangeStep } from '../../vega.schema';\nimport { signalOrStringValue } from '../common';\nimport { isFacetModel } from '../model';\nexport function assembleLayoutSignals(model) {\n    return [\n        ...sizeSignals(model, 'width'),\n        ...sizeSignals(model, 'height'),\n        ...sizeSignals(model, 'childWidth'),\n        ...sizeSignals(model, 'childHeight')\n    ];\n}\nexport function sizeSignals(model, sizeType) {\n    const channel = sizeType === 'width' ? 'x' : 'y';\n    const size = model.component.layoutSize.get(sizeType);\n    if (!size || size === 'merged') {\n        return [];\n    }\n    // Read size signal name from name map, just in case it is the top-level size signal that got renamed.\n    const name = model.getSizeSignalRef(sizeType).signal;\n    if (size === 'step') {\n        const scaleComponent = model.getScaleComponent(channel);\n        if (scaleComponent) {\n            const type = scaleComponent.get('type');\n            const range = scaleComponent.get('range');\n            if (hasDiscreteDomain(type) && isVgRangeStep(range)) {\n                const scaleName = model.scaleName(channel);\n                if (isFacetModel(model.parent)) {\n                    // If parent is facet and this is an independent scale, return only signal signal\n                    // as the width/height will be calculated using the cardinality from\n                    // facet's aggregate rather than reading from scale domain\n                    const parentResolve = model.parent.component.resolve;\n                    if (parentResolve.scale[channel] === 'independent') {\n                        return [stepSignal(scaleName, range)];\n                    }\n                }\n                return [\n                    stepSignal(scaleName, range),\n                    {\n                        name,\n                        update: sizeExpr(scaleName, scaleComponent, `domain('${scaleName}').length`)\n                    }\n                ];\n            }\n        }\n        /* istanbul ignore next: Condition should not happen -- only for warning in development. */\n        throw new Error('layout size is step although width/height is not step.');\n    }\n    else if (size == 'container') {\n        const isWidth = name.endsWith('width');\n        const expr = isWidth ? 'containerSize()[0]' : 'containerSize()[1]';\n        const defaultValue = getViewConfigContinuousSize(model.config.view, isWidth ? 'width' : 'height');\n        const safeExpr = `isFinite(${expr}) ? ${expr} : ${defaultValue}`;\n        return [{ name, init: safeExpr, on: [{ update: safeExpr, events: 'window:resize' }] }];\n    }\n    else {\n        return [\n            {\n                name,\n                value: size\n            }\n        ];\n    }\n}\nfunction stepSignal(scaleName, range) {\n    return {\n        name: `${scaleName}_step`,\n        value: range.step\n    };\n}\nexport function sizeExpr(scaleName, scaleComponent, cardinality) {\n    const type = scaleComponent.get('type');\n    const padding = scaleComponent.get('padding');\n    const paddingOuter = getFirstDefined(scaleComponent.get('paddingOuter'), padding);\n    let paddingInner = scaleComponent.get('paddingInner');\n    paddingInner =\n        type === 'band'\n            ? // only band has real paddingInner\n                paddingInner !== undefined\n                    ? paddingInner\n                    : padding\n            : // For point, as calculated in https://github.com/vega/vega-scale/blob/master/src/band.js#L128,\n                // it's equivalent to have paddingInner = 1 since there is only n-1 steps between n points.\n                1;\n    return `bandspace(${cardinality}, ${signalOrStringValue(paddingInner)}, ${signalOrStringValue(paddingOuter)}) * ${scaleName}_step`;\n}\n//# sourceMappingURL=assemble.js.map"]},"metadata":{},"sourceType":"module"}