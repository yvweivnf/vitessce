{"ast":null,"code":"import _classCallCheck from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _getPrototypeOf from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/getPrototypeOf\";import _get from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/get\";import _inherits from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import GL from'@luma.gl/constants';// eslint-disable-line import/no-extraneous-dependencies\nimport{_mergeShaders,project32,picking}from'@deck.gl/core';// eslint-disable-line import/no-extraneous-dependencies\nimport{BitmapLayer}from'@deck.gl/layers';// eslint-disable-line import/no-extraneous-dependencies\nimport{Texture2D}from'@luma.gl/core';import{PIXELATED_TEXTURE_PARAMETERS,TILE_SIZE}from'./heatmap-constants';import{GLSL_COLORMAPS,GLSL_COLORMAP_DEFAULT,COLORMAP_SHADER_PLACEHOLDER}from'./constants';import{vertexShader,fragmentShader}from'./heatmap-bitmap-layer-shaders';var defaultProps={image:{type:'object',value:null,async:true},colormap:{type:'string',value:GLSL_COLORMAP_DEFAULT,compare:true},bounds:{type:'array',value:[1,0,0,1],compare:true},aggSizeX:{type:'number',value:8.0,compare:true},aggSizeY:{type:'number',value:8.0,compare:true},colorScaleLo:{type:'number',value:0.0,compare:true},colorScaleHi:{type:'number',value:1.0,compare:true}};/**\n * A BitmapLayer that performs aggregation in the fragment shader,\n * and renders its texture from a Uint8Array rather than an ImageData.\n */var HeatmapBitmapLayer=/*#__PURE__*/function(_BitmapLayer){_inherits(HeatmapBitmapLayer,_BitmapLayer);var _super=_createSuper(HeatmapBitmapLayer);function HeatmapBitmapLayer(){_classCallCheck(this,HeatmapBitmapLayer);return _super.apply(this,arguments);}_createClass(HeatmapBitmapLayer,[{key:\"_getShaders\",/**\n   * Copy of getShaders from Layer (grandparent, parent of BitmapLayer).\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/core/src/lib/layer.js#L302\n   * @param {object} shaders\n   * @returns {object} Merged shaders.\n   */ // eslint-disable-next-line no-underscore-dangle\nvalue:function _getShaders(shaders){var _this=this;this.props.extensions.forEach(function(extension){// eslint-disable-next-line no-param-reassign\nshaders=_mergeShaders(shaders,extension.getShaders.call(_this,extension));});return shaders;}/**\n   * Need to override to provide custom shaders.\n   */},{key:\"getShaders\",value:function getShaders(){var colormap=this.props.colormap;var fragmentShaderWithColormap=GLSL_COLORMAPS.includes(colormap)?fragmentShader.replace(COLORMAP_SHADER_PLACEHOLDER,colormap):fragmentShader.replace(COLORMAP_SHADER_PLACEHOLDER,GLSL_COLORMAP_DEFAULT);// eslint-disable-next-line no-underscore-dangle\nreturn this._getShaders({vs:vertexShader,fs:fragmentShaderWithColormap,modules:[project32,picking]});}},{key:\"updateState\",value:function updateState(args){_get(_getPrototypeOf(HeatmapBitmapLayer.prototype),\"updateState\",this).call(this,args);this.loadTexture(this.props.image);var props=args.props,oldProps=args.oldProps;if(props.colormap!==oldProps.colormap){var _this$state$model;var gl=this.context.gl;// eslint-disable-next-line no-unused-expressions\n(_this$state$model=this.state.model)===null||_this$state$model===void 0?void 0:_this$state$model.delete();// eslint-disable-next-line no-underscore-dangle\nthis.state.model=this._getModel(gl);this.getAttributeManager().invalidateAll();}}/**\n   * Need to override to provide additional uniform values.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L173\n   * @param {*} opts\n   */},{key:\"draw\",value:function draw(opts){var uniforms=opts.uniforms;var _this$state=this.state,bitmapTexture=_this$state.bitmapTexture,model=_this$state.model;var _this$props=this.props,aggSizeX=_this$props.aggSizeX,aggSizeY=_this$props.aggSizeY,colorScaleLo=_this$props.colorScaleLo,colorScaleHi=_this$props.colorScaleHi;// Render the image\nif(bitmapTexture&&model){model.setUniforms(Object.assign({},uniforms,{uBitmapTexture:bitmapTexture,uTextureSize:[TILE_SIZE,TILE_SIZE],uAggSize:[aggSizeX,aggSizeY],uColorScaleRange:[colorScaleLo,colorScaleHi]})).draw();}}/**\n   * Need to override to provide the custom DEFAULT_TEXTURE_PARAMETERS\n   * object.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L218\n   * @param {Uint8Array} image\n   */},{key:\"loadTexture\",value:function loadTexture(image){var gl=this.context.gl;if(this.state.bitmapTexture){this.state.bitmapTexture.delete();}if(image instanceof Texture2D){this.setState({bitmapTexture:image});}else if(image){this.setState({bitmapTexture:new Texture2D(gl,{data:image,mipmaps:false,parameters:PIXELATED_TEXTURE_PARAMETERS,// Each color contains a single luminance value.\n// When sampled, rgb are all set to this luminance, alpha is 1.0.\n// Reference: https://luma.gl/docs/api-reference/webgl/texture#texture-formats\nformat:GL.LUMINANCE,dataFormat:GL.LUMINANCE,type:GL.UNSIGNED_BYTE,width:TILE_SIZE,height:TILE_SIZE})});}}}]);return HeatmapBitmapLayer;}(BitmapLayer);export{HeatmapBitmapLayer as default};HeatmapBitmapLayer.layerName='HeatmapBitmapLayer';HeatmapBitmapLayer.defaultProps=defaultProps;","map":{"version":3,"sources":["C:/Users/wkuo/Documents/vitessce-forked-v1.2.2/vitessce/src/layers/HeatmapBitmapLayer.js"],"names":["GL","_mergeShaders","project32","picking","BitmapLayer","Texture2D","PIXELATED_TEXTURE_PARAMETERS","TILE_SIZE","GLSL_COLORMAPS","GLSL_COLORMAP_DEFAULT","COLORMAP_SHADER_PLACEHOLDER","vertexShader","fragmentShader","defaultProps","image","type","value","async","colormap","compare","bounds","aggSizeX","aggSizeY","colorScaleLo","colorScaleHi","HeatmapBitmapLayer","shaders","props","extensions","forEach","extension","getShaders","call","fragmentShaderWithColormap","includes","replace","_getShaders","vs","fs","modules","args","loadTexture","oldProps","gl","context","state","model","delete","_getModel","getAttributeManager","invalidateAll","opts","uniforms","bitmapTexture","setUniforms","Object","assign","uBitmapTexture","uTextureSize","uAggSize","uColorScaleRange","draw","setState","data","mipmaps","parameters","format","LUMINANCE","dataFormat","UNSIGNED_BYTE","width","height","layerName"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants'; // eslint-disable-line import/no-extraneous-dependencies\nimport { _mergeShaders, project32, picking } from '@deck.gl/core'; // eslint-disable-line import/no-extraneous-dependencies\nimport { BitmapLayer } from '@deck.gl/layers'; // eslint-disable-line import/no-extraneous-dependencies\nimport { Texture2D } from '@luma.gl/core';\nimport { PIXELATED_TEXTURE_PARAMETERS, TILE_SIZE } from './heatmap-constants';\nimport {\n  GLSL_COLORMAPS,\n  GLSL_COLORMAP_DEFAULT,\n  COLORMAP_SHADER_PLACEHOLDER,\n} from './constants';\nimport { vertexShader, fragmentShader } from './heatmap-bitmap-layer-shaders';\n\nconst defaultProps = {\n  image: { type: 'object', value: null, async: true },\n  colormap: { type: 'string', value: GLSL_COLORMAP_DEFAULT, compare: true },\n  bounds: { type: 'array', value: [1, 0, 0, 1], compare: true },\n  aggSizeX: { type: 'number', value: 8.0, compare: true },\n  aggSizeY: { type: 'number', value: 8.0, compare: true },\n  colorScaleLo: { type: 'number', value: 0.0, compare: true },\n  colorScaleHi: { type: 'number', value: 1.0, compare: true },\n};\n/**\n * A BitmapLayer that performs aggregation in the fragment shader,\n * and renders its texture from a Uint8Array rather than an ImageData.\n */\nexport default class HeatmapBitmapLayer extends BitmapLayer {\n  /**\n   * Copy of getShaders from Layer (grandparent, parent of BitmapLayer).\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/core/src/lib/layer.js#L302\n   * @param {object} shaders\n   * @returns {object} Merged shaders.\n   */\n  // eslint-disable-next-line no-underscore-dangle\n  _getShaders(shaders) {\n    this.props.extensions.forEach((extension) => {\n      // eslint-disable-next-line no-param-reassign\n      shaders = _mergeShaders(\n        shaders,\n        extension.getShaders.call(this, extension),\n      );\n    });\n    return shaders;\n  }\n\n  /**\n   * Need to override to provide custom shaders.\n   */\n  getShaders() {\n    const { colormap } = this.props;\n    const fragmentShaderWithColormap = GLSL_COLORMAPS.includes(colormap)\n      ? fragmentShader.replace(COLORMAP_SHADER_PLACEHOLDER, colormap)\n      : fragmentShader.replace(\n        COLORMAP_SHADER_PLACEHOLDER,\n        GLSL_COLORMAP_DEFAULT,\n      );\n    // eslint-disable-next-line no-underscore-dangle\n    return this._getShaders({\n      vs: vertexShader,\n      fs: fragmentShaderWithColormap,\n      modules: [project32, picking],\n    });\n  }\n\n  updateState(args) {\n    super.updateState(args);\n    this.loadTexture(this.props.image);\n    const { props, oldProps } = args;\n    if (props.colormap !== oldProps.colormap) {\n      const { gl } = this.context;\n      // eslint-disable-next-line no-unused-expressions\n      this.state.model?.delete();\n      // eslint-disable-next-line no-underscore-dangle\n      this.state.model = this._getModel(gl);\n      this.getAttributeManager().invalidateAll();\n    }\n  }\n\n  /**\n   * Need to override to provide additional uniform values.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L173\n   * @param {*} opts\n   */\n  draw(opts) {\n    const { uniforms } = opts;\n    const { bitmapTexture, model } = this.state;\n    const {\n      aggSizeX, aggSizeY, colorScaleLo, colorScaleHi,\n    } = this.props;\n\n    // Render the image\n    if (bitmapTexture && model) {\n      model\n        .setUniforms(\n          Object.assign({}, uniforms, {\n            uBitmapTexture: bitmapTexture,\n            uTextureSize: [TILE_SIZE, TILE_SIZE],\n            uAggSize: [aggSizeX, aggSizeY],\n            uColorScaleRange: [colorScaleLo, colorScaleHi],\n          }),\n        )\n        .draw();\n    }\n  }\n\n  /**\n   * Need to override to provide the custom DEFAULT_TEXTURE_PARAMETERS\n   * object.\n   * Simplified by removing video-related code.\n   * Reference: https://github.com/visgl/deck.gl/blob/0afd4e99a6199aeec979989e0c361c97e6c17a16/modules/layers/src/bitmap-layer/bitmap-layer.js#L218\n   * @param {Uint8Array} image\n   */\n  loadTexture(image) {\n    const { gl } = this.context;\n\n    if (this.state.bitmapTexture) {\n      this.state.bitmapTexture.delete();\n    }\n\n    if (image instanceof Texture2D) {\n      this.setState({\n        bitmapTexture: image,\n      });\n    } else if (image) {\n      this.setState({\n        bitmapTexture: new Texture2D(gl, {\n          data: image,\n          mipmaps: false,\n          parameters: PIXELATED_TEXTURE_PARAMETERS,\n          // Each color contains a single luminance value.\n          // When sampled, rgb are all set to this luminance, alpha is 1.0.\n          // Reference: https://luma.gl/docs/api-reference/webgl/texture#texture-formats\n          format: GL.LUMINANCE,\n          dataFormat: GL.LUMINANCE,\n          type: GL.UNSIGNED_BYTE,\n          width: TILE_SIZE,\n          height: TILE_SIZE,\n        }),\n      });\n    }\n  }\n}\nHeatmapBitmapLayer.layerName = 'HeatmapBitmapLayer';\nHeatmapBitmapLayer.defaultProps = defaultProps;\n"]},"metadata":{},"sourceType":"module"}