{"ast":null,"code":"import _slicedToArray from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import _regeneratorRuntime from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _objectSpread from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _asyncToGenerator from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _inherits from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\wkuo\\\\Documents\\\\vitessce-forked-v1.2.2\\\\vitessce\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import{loadOmeZarr}from'@hms-dbmi/viv';import{AbstractLoaderError}from'./errors';import LoaderResult from'./LoaderResult';import{initializeRasterLayersAndChannels}from'../components/spatial/utils';import AbstractTwoStepLoader from'./AbstractTwoStepLoader';function hexToRgb(hex){var result=/^#?([A-F\\d]{2})([A-F\\d]{2})([A-F\\d]{2})$/i.exec(hex);return[parseInt(result[1].toLowerCase(),16),parseInt(result[2].toLowerCase(),16),parseInt(result[3].toLowerCase(),16)];}var OmeZarrLoader=/*#__PURE__*/function(_AbstractTwoStepLoade){_inherits(OmeZarrLoader,_AbstractTwoStepLoade);var _super=_createSuper(OmeZarrLoader);function OmeZarrLoader(){_classCallCheck(this,OmeZarrLoader);return _super.apply(this,arguments);}_createClass(OmeZarrLoader,[{key:\"load\",value:function(){var _load=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var _rdefs$defaultT,_rdefs$defaultZ;var payload,loader,metadata,data,omero,rdefs,channels,t,z,filterSelection,imagesWithLoaderCreators,_yield$initializeRast,_yield$initializeRast2,autoImageLayers,imageLayerLoaders,imageLayerMeta,coordinationValues;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this.dataSource.getJson('.zattrs').catch(function(reason){return Promise.resolve(reason);});case 2:payload=_context2.sent;if(!(payload instanceof AbstractLoaderError)){_context2.next=5;break;}return _context2.abrupt(\"return\",Promise.reject(payload));case 5:_context2.next=7;return loadOmeZarr(this.url,{fetchOptions:this.requestInit,type:'multiscales'});case 7:loader=_context2.sent;metadata=loader.metadata,data=loader.data;omero=metadata.omero;if(omero){_context2.next=13;break;}console.error('Path for image not valid');return _context2.abrupt(\"return\",Promise.reject(payload));case 13:rdefs=omero.rdefs,channels=omero.channels;t=(_rdefs$defaultT=rdefs.defaultT)!==null&&_rdefs$defaultT!==void 0?_rdefs$defaultT:0;z=(_rdefs$defaultZ=rdefs.defaultZ)!==null&&_rdefs$defaultZ!==void 0?_rdefs$defaultZ:0;filterSelection=function filterSelection(sel){// Remove selection keys for which there is no dimension.\nif(data.length>0){var nextSel={};// eslint-disable-next-line prefer-destructuring\nvar labels=data[0].labels;Object.keys(sel).forEach(function(key){if(labels.includes(key)){nextSel[key]=sel[key];}});return nextSel;}return sel;};imagesWithLoaderCreators=[{name:omero.name||'Image',channels:channels.map(function(channel,i){return{selection:filterSelection({z:z,t:t,c:i}),slider:[channel.window.start,channel.window.end],color:hexToRgb(channel.color)};}),loaderCreator:function(){var _loaderCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",_objectSpread({},loader,{channels:channels.map(function(c){return c.label;})}));case 1:case\"end\":return _context.stop();}}},_callee);}));function loaderCreator(){return _loaderCreator.apply(this,arguments);}return loaderCreator;}()}];// TODO: use options for initial selection of channels\n// which omit domain/slider ranges.\n_context2.next=20;return initializeRasterLayersAndChannels(imagesWithLoaderCreators,undefined);case 20:_yield$initializeRast=_context2.sent;_yield$initializeRast2=_slicedToArray(_yield$initializeRast,3);autoImageLayers=_yield$initializeRast2[0];imageLayerLoaders=_yield$initializeRast2[1];imageLayerMeta=_yield$initializeRast2[2];coordinationValues={spatialImageLayer:autoImageLayers};return _context2.abrupt(\"return\",Promise.resolve(new LoaderResult({loaders:imageLayerLoaders,meta:imageLayerMeta},[],coordinationValues)));case 27:case\"end\":return _context2.stop();}}},_callee2,this);}));function load(){return _load.apply(this,arguments);}return load;}()}]);return OmeZarrLoader;}(AbstractTwoStepLoader);export{OmeZarrLoader as default};","map":{"version":3,"sources":["C:/Users/wkuo/Documents/vitessce-forked-v1.2.2/vitessce/src/loaders/OmeZarrLoader.js"],"names":["loadOmeZarr","AbstractLoaderError","LoaderResult","initializeRasterLayersAndChannels","AbstractTwoStepLoader","hexToRgb","hex","result","exec","parseInt","toLowerCase","OmeZarrLoader","dataSource","getJson","catch","reason","Promise","resolve","payload","reject","url","fetchOptions","requestInit","type","loader","metadata","data","omero","console","error","rdefs","channels","t","defaultT","z","defaultZ","filterSelection","sel","length","nextSel","labels","Object","keys","forEach","key","includes","imagesWithLoaderCreators","name","map","channel","i","selection","c","slider","window","start","end","color","loaderCreator","label","undefined","autoImageLayers","imageLayerLoaders","imageLayerMeta","coordinationValues","spatialImageLayer","loaders","meta"],"mappings":"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","sourcesContent":["import { loadOmeZarr } from '@hms-dbmi/viv';\nimport { AbstractLoaderError } from './errors';\nimport LoaderResult from './LoaderResult';\n\nimport { initializeRasterLayersAndChannels } from '../components/spatial/utils';\nimport AbstractTwoStepLoader from './AbstractTwoStepLoader';\n\nfunction hexToRgb(hex) {\n  const result = /^#?([A-F\\d]{2})([A-F\\d]{2})([A-F\\d]{2})$/i.exec(hex);\n  return [\n    parseInt(result[1].toLowerCase(), 16),\n    parseInt(result[2].toLowerCase(), 16),\n    parseInt(result[3].toLowerCase(), 16),\n  ];\n}\n\nexport default class OmeZarrLoader extends AbstractTwoStepLoader {\n  async load() {\n    const payload = await this.dataSource.getJson('.zattrs').catch(reason => Promise.resolve(reason));\n    if (payload instanceof AbstractLoaderError) {\n      return Promise.reject(payload);\n    }\n\n    const loader = await loadOmeZarr(this.url, { fetchOptions: this.requestInit, type: 'multiscales' });\n    const { metadata, data } = loader;\n\n    const { omero } = metadata;\n\n    if (!omero) {\n      console.error('Path for image not valid');\n      return Promise.reject(payload);\n    }\n\n    const { rdefs, channels } = omero;\n\n    const t = rdefs.defaultT ?? 0;\n    const z = rdefs.defaultZ ?? 0;\n\n    const filterSelection = (sel) => {\n      // Remove selection keys for which there is no dimension.\n      if (data.length > 0) {\n        const nextSel = {};\n        // eslint-disable-next-line prefer-destructuring\n        const labels = data[0].labels;\n        Object.keys(sel).forEach((key) => {\n          if (labels.includes(key)) {\n            nextSel[key] = sel[key];\n          }\n        });\n        return nextSel;\n      }\n      return sel;\n    };\n\n    const imagesWithLoaderCreators = [\n      {\n        name: omero.name || 'Image',\n        channels: channels.map((channel, i) => ({\n          selection: filterSelection({ z, t, c: i }),\n          slider: [channel.window.start, channel.window.end],\n          color: hexToRgb(channel.color),\n        })),\n        loaderCreator: async () => ({ ...loader, channels: channels.map(c => c.label) }),\n      },\n    ];\n\n    // TODO: use options for initial selection of channels\n    // which omit domain/slider ranges.\n    const [\n      autoImageLayers, imageLayerLoaders, imageLayerMeta,\n    ] = await initializeRasterLayersAndChannels(\n      imagesWithLoaderCreators, undefined,\n    );\n\n    const coordinationValues = {\n      spatialImageLayer: autoImageLayers,\n    };\n    return Promise.resolve(new LoaderResult(\n      { loaders: imageLayerLoaders, meta: imageLayerMeta },\n      [],\n      coordinationValues,\n    ));\n  }\n}\n"]},"metadata":{},"sourceType":"module"}