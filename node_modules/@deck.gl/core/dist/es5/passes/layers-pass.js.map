{"version":3,"sources":["../../../src/passes/layers-pass.js"],"names":["LayersPass","props","gl","framebuffer","target","_drawLayers","viewports","views","onViewportActive","clearCanvas","pass","clearGLCanvas","renderStats","viewportOrDescriptor","viewport","view","id","drawLayerParams","_getDrawLayerParams","subViewports","subViewport","stats","_drawLayersInViewport","push","layers","layerFilter","effects","moduleParameters","indexResolver","layerIndexResolver","drawContext","isPicking","startsWith","renderPass","layerFilterCache","layerIndex","length","layer","shouldDrawLayer","_shouldDrawLayer","layerRenderIndex","layerParam","_getModuleParameters","layerParameters","getLayerParameters","glViewport","getGLViewport","clear","clearOpts","color","depth","scissorTest","scissor","renderStatus","totalCount","visibleCount","compositeCount","pickableCount","pickable","isComposite","drawLayer","uniforms","parameters","err","raiseError","visible","parent","filterSubLayer","rootLayerId","activateViewport","overrides","Object","assign","create","autoWrapLongitude","wrapLongitude","context","mousePosition","pickingActive","devicePixelRatio","effect","getModuleParameters","Pass","startIndex","layerIndices","resolvers","resolveLayerIndex","isDrawn","indexOverride","_offset","layerId","parentId","index","resolver","Number","isFinite","height","canvas","clientHeight","dimensions","pixelRatio","x","y","width","drawingBufferWidth","drawingBufferHeight"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport Pass from './pass';\nimport {clear, setParameters, withParameters, cssToDeviceRatio} from '@luma.gl/core';\n\nexport default class LayersPass extends Pass {\n  render(props) {\n    const gl = this.gl;\n\n    setParameters(gl, {framebuffer: props.target});\n    return this._drawLayers(props);\n  }\n\n  // PRIVATE\n  // Draw a list of layers in a list of viewports\n  _drawLayers(props) {\n    const {viewports, views, onViewportActive, clearCanvas = true} = props;\n    props.pass = props.pass || 'unknown';\n\n    const gl = this.gl;\n    if (clearCanvas) {\n      clearGLCanvas(gl);\n    }\n\n    const renderStats = [];\n\n    for (const viewportOrDescriptor of viewports) {\n      // Get a viewport from a viewport descriptor (which can be a plain viewport)\n      const viewport = viewportOrDescriptor.viewport || viewportOrDescriptor;\n      const view = views && views[viewport.id];\n\n      // Update context to point to this viewport\n      onViewportActive(viewport);\n\n      const drawLayerParams = this._getDrawLayerParams(viewport, props);\n\n      props.view = view;\n\n      // render this viewport\n      const subViewports = viewport.subViewports || [viewport];\n      for (const subViewport of subViewports) {\n        props.viewport = subViewport;\n\n        const stats = this._drawLayersInViewport(gl, props, drawLayerParams);\n        renderStats.push(stats);\n      }\n    }\n    return renderStats;\n  }\n\n  // Resolve the parameters needed to draw each layer\n  // When a viewport contains multiple subviewports (e.g. repeated web mercator map),\n  // this is only done once for the parent viewport\n  _getDrawLayerParams(viewport, {layers, pass, layerFilter, effects, moduleParameters}) {\n    const drawLayerParams = [];\n    const indexResolver = layerIndexResolver();\n    const drawContext = {\n      viewport,\n      isPicking: pass.startsWith('picking'),\n      renderPass: pass\n    };\n    const layerFilterCache = {};\n    for (let layerIndex = 0; layerIndex < layers.length; layerIndex++) {\n      const layer = layers[layerIndex];\n      // Check if we should draw layer\n      const shouldDrawLayer = this._shouldDrawLayer(\n        layer,\n        drawContext,\n        layerFilter,\n        layerFilterCache\n      );\n\n      // This is the \"logical\" index for ordering this layer in the stack\n      // used to calculate polygon offsets\n      // It can be the same as another layer\n      const layerRenderIndex = indexResolver(layer, shouldDrawLayer);\n\n      const layerParam = {\n        shouldDrawLayer,\n        layerRenderIndex\n      };\n\n      if (shouldDrawLayer) {\n        layerParam.moduleParameters = this._getModuleParameters(\n          layer,\n          effects,\n          pass,\n          moduleParameters\n        );\n        layerParam.layerParameters = this.getLayerParameters(layer, layerIndex, viewport);\n      }\n      drawLayerParams[layerIndex] = layerParam;\n    }\n    return drawLayerParams;\n  }\n\n  // Draws a list of layers in one viewport\n  // TODO - when picking we could completely skip rendering viewports that dont\n  // intersect with the picking rect\n  /* eslint-disable max-depth, max-statements */\n  _drawLayersInViewport(gl, {layers, pass, viewport, view}, drawLayerParams) {\n    const glViewport = getGLViewport(gl, {viewport});\n\n    if (view && view.props.clear) {\n      const clearOpts = view.props.clear === true ? {color: true, depth: true} : view.props.clear;\n      withParameters(\n        gl,\n        {\n          scissorTest: true,\n          scissor: glViewport\n        },\n        () => clear(gl, clearOpts)\n      );\n    }\n\n    // render layers in normal colors\n    const renderStatus = {\n      totalCount: layers.length,\n      visibleCount: 0,\n      compositeCount: 0,\n      pickableCount: 0\n    };\n\n    setParameters(gl, {viewport: glViewport});\n\n    // render layers in normal colors\n    for (let layerIndex = 0; layerIndex < layers.length; layerIndex++) {\n      const layer = layers[layerIndex];\n      const {\n        shouldDrawLayer,\n        layerRenderIndex,\n        moduleParameters,\n        layerParameters\n      } = drawLayerParams[layerIndex];\n\n      // Calculate stats\n      if (shouldDrawLayer && layer.props.pickable) {\n        renderStatus.pickableCount++;\n      }\n      if (layer.isComposite) {\n        renderStatus.compositeCount++;\n      } else if (shouldDrawLayer) {\n        // Draw the layer\n        renderStatus.visibleCount++;\n\n        // overwrite layer.context.viewport with the sub viewport\n        moduleParameters.viewport = viewport;\n\n        try {\n          layer.drawLayer({\n            moduleParameters,\n            uniforms: {layerIndex: layerRenderIndex},\n            parameters: layerParameters\n          });\n        } catch (err) {\n          layer.raiseError(err, `drawing ${layer} to ${pass}`);\n        }\n      }\n    }\n\n    return renderStatus;\n  }\n  /* eslint-enable max-depth, max-statements */\n\n  /* Methods for subclass overrides */\n  shouldDrawLayer(layer) {\n    return true;\n  }\n\n  getModuleParameters(layer, effects) {\n    return null;\n  }\n\n  getLayerParameters(layer, layerIndex) {\n    return layer.props.parameters;\n  }\n\n  /* Private */\n  _shouldDrawLayer(layer, drawContext, layerFilter, layerFilterCache) {\n    const shouldDrawLayer = this.shouldDrawLayer(layer) && layer.props.visible;\n\n    if (!shouldDrawLayer) {\n      return false;\n    }\n\n    drawContext.layer = layer;\n\n    let parent = layer.parent;\n    while (parent) {\n      if (!parent.props.visible || !parent.filterSubLayer(drawContext)) {\n        return false;\n      }\n      drawContext.layer = parent;\n      parent = parent.parent;\n    }\n\n    if (layerFilter) {\n      const rootLayerId = drawContext.layer.id;\n      if (!(rootLayerId in layerFilterCache)) {\n        layerFilterCache[rootLayerId] = layerFilter(drawContext);\n      }\n      if (!layerFilterCache[rootLayerId]) {\n        return false;\n      }\n    }\n\n    // If a layer is drawn, update its viewportChanged flag\n    layer.activateViewport(drawContext.viewport);\n\n    return true;\n  }\n\n  _getModuleParameters(layer, effects, pass, overrides) {\n    const moduleParameters = Object.assign(Object.create(layer.props), {\n      autoWrapLongitude: layer.wrapLongitude,\n      viewport: layer.context.viewport,\n      mousePosition: layer.context.mousePosition,\n      pickingActive: 0,\n      devicePixelRatio: cssToDeviceRatio(this.gl)\n    });\n\n    if (effects) {\n      for (const effect of effects) {\n        Object.assign(moduleParameters, effect.getModuleParameters(layer));\n      }\n    }\n\n    return Object.assign(moduleParameters, this.getModuleParameters(layer, effects), overrides);\n  }\n}\n\n// If the _index prop is defined, return a layer index that's relative to its parent\n// Otherwise return the index of the layer among all rendered layers\n// This is done recursively, i.e. if the user overrides a layer's default index,\n// all its descendants will be resolved relative to that index.\n// This implementation assumes that parent layers always appear before its children\n// which is true if the layer array comes from the LayerManager\nexport function layerIndexResolver(startIndex = 0, layerIndices = {}) {\n  const resolvers = {};\n\n  const resolveLayerIndex = (layer, isDrawn) => {\n    const indexOverride = layer.props._offset;\n    const layerId = layer.id;\n    const parentId = layer.parent && layer.parent.id;\n\n    let index;\n\n    if (parentId && !(parentId in layerIndices)) {\n      // Populate layerIndices with the parent layer's index\n      resolveLayerIndex(layer.parent, false);\n    }\n\n    if (parentId in resolvers) {\n      const resolver = (resolvers[parentId] =\n        resolvers[parentId] || layerIndexResolver(layerIndices[parentId], layerIndices));\n      index = resolver(layer, isDrawn);\n      resolvers[layerId] = resolver;\n    } else if (Number.isFinite(indexOverride)) {\n      index = indexOverride + (layerIndices[parentId] || 0);\n      // Mark layer as needing its own resolver\n      // We don't actually create it until it's used for the first time\n      resolvers[layerId] = null;\n    } else {\n      index = startIndex;\n    }\n\n    if (isDrawn && index >= startIndex) {\n      startIndex = index + 1;\n    }\n\n    layerIndices[layerId] = index;\n    return index;\n  };\n  return resolveLayerIndex;\n}\n\n// Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\nfunction getGLViewport(gl, {viewport}) {\n  // TODO - dummy default for node\n  // Fallback to width/height when clientWidth/clientHeight are 0 or undefined.\n  const height = gl.canvas ? gl.canvas.clientHeight || gl.canvas.height : 100;\n  // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n  const dimensions = viewport;\n  const pixelRatio = cssToDeviceRatio(gl);\n  return [\n    dimensions.x * pixelRatio,\n    (height - dimensions.y - dimensions.height) * pixelRatio,\n    dimensions.width * pixelRatio,\n    dimensions.height * pixelRatio\n  ];\n}\n\nfunction clearGLCanvas(gl) {\n  const width = gl.drawingBufferWidth;\n  const height = gl.drawingBufferHeight;\n  // clear depth and color buffers, restoring transparency\n  setParameters(gl, {viewport: [0, 0, width, height]});\n  gl.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);\n}\n"],"file":"layers-pass.js"}